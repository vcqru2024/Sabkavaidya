SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET NOCOUNT ON
SET QUOTED_IDENTIFIER ON
SET XACT_ABORT ON
GO

--------------------
-- Schema Statements
--------------------
BEGIN TRANSACTION
	
	-- Support user payment verification
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration ADD
		UserPaymentVerificationActive bit NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_UserPaymentVerificationActive DEFAULT 0,
		UserPaymentVerificationAmount decimal(19, 4) NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_UserPaymentVerificationAmount DEFAULT 1.00

	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_UserPaymentVerificationActive
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_UserPaymentVerificationAmount

	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration ADD UserPaymentActive bit NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_UserPaymentActive DEFAULT 0
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_UserPaymentActive

	-- Support automatic retry payment
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration ADD RecurringSalesOrderPaymentIncompleteRetryInterval int NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_RecurringSalesOrderPaymentIncompleteRetryInterval DEFAULT 0
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_RecurringSalesOrderPaymentIncompleteRetryInterval
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration ADD RecurringSalesOrderPaymentIncompleteRetryMaxRepeat int NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_RecurringSalesOrderPaymentIncompleteRetryMaxRepeat DEFAULT 1
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_RecurringSalesOrderPaymentIncompleteRetryMaxRepeat

	-- Support SalesPayment alert email
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration ADD
		CommunicationSalesPaymentAlertEmailActive bit NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_CommunicationSalesPaymentAlertEmailActive DEFAULT 1,
		CommunicationSalesPaymentAlertEmailTemplate xml NULL
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_CommunicationSalesPaymentAlertEmailActive

	-- Support RecurringSalesOrderPaymentIncompleteRetry
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration ADD
		CommunicationRecurringSalesOrderPaymentIncompleteRetryCountdown int NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_CommunicationRecurringSalesOrderPaymentIncompleteRetryCountdown DEFAULT 86400,
		CommunicationRecurringSalesOrderPaymentIncompleteRetryEmailActive bit NOT NULL CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_CommunicationRecurringSalesOrderPaymentIncompleteRetryEmailActive DEFAULT 1,
		CommunicationRecurringSalesOrderPaymentIncompleteRetryEmailTemplate xml NULL

	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_CommunicationRecurringSalesOrderPaymentIncompleteRetryCountdown
	ALTER TABLE {databaseOwner}{objectQualifier}Revindex_Storefront_Configuration DROP CONSTRAINT DF_{objectQualifier}Revindex_Storefront_Configuration_CommunicationRecurringSalesOrderPaymentIncompleteRetryEmailActive

COMMIT TRANSACTION
GO

-----------------
-- DML Statements
-----------------
BEGIN TRY
	BEGIN TRANSACTION

		-- Change USPS service name
		UPDATE {databaseOwner}{objectQualifier}Revindex_Storefront_ShippingMethod SET UniversalServiceName = 'USPS:USPS GXG&LT;SUP&GT;&#8482;&LT;/SUP&GT; ENVELOPES' WHERE UniversalServiceName = 'USPS:USPS GXG&LT;SUP&GT;&#8482;&LT;/SUP&GT; ENVELOPES**'
		UPDATE {databaseOwner}{objectQualifier}Revindex_Storefront_SalesOrder SET ShippingUniversalServiceName = 'USPS:USPS GXG&LT;SUP&GT;&#8482;&LT;/SUP&GT; ENVELOPES' WHERE ShippingUniversalServiceName = 'USPS:USPS GXG&LT;SUP&GT;&#8482;&LT;/SUP&GT; ENVELOPES**'

		UPDATE {databaseOwner}{objectQualifier}Revindex_Storefront_ShippingMethod SET UniversalServiceName = 'USPS:FIRST-CLASS PACKAGE INTERNATIONAL SERVICE&LT;SUP&GT;&#8482;&LT;/SUP&GT;' WHERE UniversalServiceName = 'USPS:FIRST-CLASS PACKAGE INTERNATIONAL SERVICE&LT;SUP&GT;&#8482;&LT;/SUP&GT;**'
		UPDATE {databaseOwner}{objectQualifier}Revindex_Storefront_SalesOrder SET ShippingUniversalServiceName = 'USPS:FIRST-CLASS PACKAGE INTERNATIONAL SERVICE&LT;SUP&GT;&#8482;&LT;/SUP&GT;' WHERE ShippingUniversalServiceName = 'USPS:FIRST-CLASS PACKAGE INTERNATIONAL SERVICE&LT;SUP&GT;&#8482;&LT;/SUP&GT;**'

		-- Fix missing SalesPayment.Origin in UserPaymentControl
		UPDATE {databaseOwner}{objectQualifier}Revindex_Storefront_SalesPayment SET Origin = 3 WHERE Origin = 0

		-- Set new email template for recurring order payment incomplete retry
		UPDATE {databaseOwner}[{objectQualifier}Revindex_Storefront_Configuration] SET CommunicationRecurringSalesOrderPaymentIncompleteRetryEmailTemplate = '<locale en-US="&lt;rule version=&quot;1.0&quot; type=&quot;data&quot;&gt;&amp;lt;data method=&quot;BasicRecurringSalesOrderPaymentIncompleteRetryEmail&quot; version=&quot;1.0&quot;&amp;gt;&#xD;&#xA;  &amp;lt;mailFrom&amp;gt;&amp;lt;/mailFrom&amp;gt;&#xD;&#xA;  &amp;lt;mailTo&amp;gt;&amp;lt;/mailTo&amp;gt;&#xD;&#xA;  &amp;lt;mailBcc&amp;gt;&amp;lt;/mailBcc&amp;gt;&#xD;&#xA;  &amp;lt;subject&amp;gt;[[xsl:value-of select=&quot;in/configuration/generalStoreName&quot; /]] Payment Retry [[[xsl:value-of select=&quot;in/user/username&quot; /]] - Order #[[xsl:value-of select=&quot;in/salesOrder/salesOrderNumber&quot; /]]]&amp;lt;/subject&amp;gt;&#xD;&#xA;  &amp;lt;htmlBody&amp;gt;&amp;amp;lt;p&amp;amp;gt;Hi [[xsl:if test=&amp;amp;amp;quot;in/user/profile/profileProperties/FirstName&amp;amp;amp;quot; ]] [[xsl:value-of select=&amp;amp;amp;quot;in/user/profile/profileProperties/FirstName&amp;amp;amp;quot; /]]&amp;amp;amp;nbsp;[[xsl:value-of select=&amp;amp;amp;quot;in/user/profile/profileProperties/LastName&amp;amp;amp;quot; /]][[/xsl:if]],&amp;amp;lt;/p&amp;amp;gt;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;p&amp;amp;gt;We were unable to process payment for this order the last time. This is a friendly reminder that we will automatically re-attempt processing payment soon. Please ensure that your address and payment information on file are up-to-date to prevent any service interruption. We hope you continue enjoying our service. If you have any questions, please do not hesitate to contact us.&amp;amp;lt;/p&amp;amp;gt;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;p&amp;amp;gt;If you prefer, you may [[xsl:variable name=&amp;amp;amp;quot;ManageOrderUrl&amp;amp;amp;quot; select=&amp;amp;amp;quot;concat(&amp;amp;amp;#39;http://&amp;amp;amp;#39;, in/portal/portalAliases/portalAlias[isPrimary=&amp;amp;amp;#39;true&amp;amp;amp;#39;][1]/httpAlias, &amp;amp;amp;#39;?tabid=&amp;amp;amp;#39;, in/portal/manageOrderTabs/tab[1]/tabID, &amp;amp;amp;#39;&amp;amp;amp;amp;rvdsfsoguid=&amp;amp;amp;#39;, in/salesOrder/salesOrderGUID)&amp;amp;amp;quot; /]] &amp;amp;lt;a href=&quot;[[xsl:value-of select=''$ManageOrderUrl'' /]]&quot;&amp;amp;gt;click here to make your payment&amp;amp;lt;/a&amp;amp;gt;&amp;amp;amp;nbsp;directly. If you have any questions or need assistance, please do not hesitate to contact us.&amp;amp;lt;/p&amp;amp;gt;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;3&quot; style=&quot;width: 100%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Invoice Number:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/salesOrderNumber&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;PO Number:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/purchaseOrderNumber&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Order Date:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;format-dateTime(in/salesOrder/orderDate, &amp;amp;amp;#39;[Y]-[M01]-[D01] [H01]:[m01]&amp;amp;amp;#39;)&amp;amp;amp;quot;/]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;vertical-align: top;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Bill To:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingCompany&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingFirstName&amp;amp;amp;quot; /]] [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingLastName&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingStreet&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingCity&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingSubdivisionName&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingPostalCode&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingCountryName&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;vertical-align: top;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Ship To:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingCompany&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingFirstName&amp;amp;amp;quot; /]] [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingLastName&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingStreet&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingCity&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingSubdivisionName&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingPostalCode&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingCountryName&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;vertical-align: top;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Payment:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:for-each select=&amp;amp;amp;quot;in/salesOrder/salesPayments/salesPayment&amp;amp;amp;quot;]] [[xsl:value-of select=&amp;amp;amp;quot;paymentMethodName&amp;amp;amp;quot;/]]&amp;amp;amp;nbsp;[[xsl:value-of select=&amp;amp;amp;quot;creditCardHint&amp;amp;amp;quot;/]][[xsl:value-of select=&amp;amp;amp;quot;paymentHint&amp;amp;amp;quot;/]][[xsl:value-of select=&amp;amp;amp;quot;voucherHint&amp;amp;amp;quot;/]]&amp;amp;amp;nbsp;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(amount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[/xsl:for-each]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;&amp;amp;amp;nbsp;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;1&quot; cellpadding=&quot;3&quot; cellspacing=&quot;0&quot; style=&quot;width: 100%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 60%;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Item&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 15%;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Quantity&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 25%;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Amount&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;[[xsl:for-each select=&amp;amp;amp;quot;in/salesOrder/salesOrderDetails/salesOrderDetail[parentSalesOrderDetailID=&amp;amp;amp;#39;&amp;amp;amp;#39;]&amp;amp;amp;quot;]]&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;1&quot; cellpadding=&quot;3&quot; cellspacing=&quot;0&quot; style=&quot;width: 100%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 60%;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;productName&amp;amp;amp;quot; /]] - [[xsl:value-of select=&amp;amp;amp;quot;productVariantName&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:for-each select=&amp;amp;amp;quot;salesOrderDetails/salesOrderDetail&amp;amp;amp;quot;]]&amp;amp;amp;nbsp;&amp;amp;amp;nbsp;&amp;amp;amp;nbsp;&amp;amp;amp;nbsp;[[xsl:value-of select=&amp;amp;amp;quot;productName&amp;amp;amp;quot; /]] - [[xsl:value-of select=&amp;amp;amp;quot;productVariantName&amp;amp;amp;quot; /]]: [[xsl:value-of select=&amp;amp;amp;quot;quantity&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[/xsl:for-each]] [[xsl:for-each select=&amp;amp;amp;quot;dynamicFormResult/fields/field&amp;amp;amp;quot;]][[xsl:value-of select=&amp;amp;amp;quot;@id&amp;amp;amp;quot; /]]: [[xsl:value-of select=&amp;amp;amp;quot;.&amp;amp;amp;quot; /]], [[/xsl:for-each]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 15%;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;quantity&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 25%;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(combinedAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;[[/xsl:for-each]]&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;p&amp;amp;gt;[[xsl:for-each select=&amp;amp;amp;quot;in/salesOrder/dynamicFormResult/fields/field&amp;amp;amp;quot;]][[xsl:value-of select=&amp;amp;amp;quot;@id&amp;amp;amp;quot; /]]: [[xsl:value-of select=&amp;amp;amp;quot;.&amp;amp;amp;quot; /]], [[/xsl:for-each]]&amp;amp;amp;nbsp;&amp;amp;lt;/p&amp;amp;gt;&#xD;&#xA;&amp;amp;amp;nbsp;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;0&quot; cellpadding=&quot;3&quot; cellspacing=&quot;0&quot; style=&quot;width: 30%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Discount:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(sum(in/salesOrder/salesOrderDetails/salesOrderDetail/discountAmount) * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Sub-Total:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/subTotalAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Shipping:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/shippingAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Handling:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/handlingAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Taxes:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number((in/salesOrder/taxAmount1 + in/salesOrder/taxAmount2 + in/salesOrder/taxAmount3 + in/salesOrder/taxAmount4 + in/salesOrder/taxAmount5) * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Total:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/totalAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Total Savings:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number((sum(in/salesOrder/salesOrderDetails/salesOrderDetail/discountAmount) + in/salesOrder/handlingDiscountAmount + in/salesOrder/shippingDiscountAmount + in/salesOrder/taxDiscountAmount) * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Points earned:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/rewardsPointsQualified&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;&amp;lt;/htmlBody&amp;gt;&#xD;&#xA;&amp;lt;/data&amp;gt;&lt;/rule&gt;" />'

		-- Set new email template for sales payment alert
		UPDATE {databaseOwner}[{objectQualifier}Revindex_Storefront_Configuration] SET CommunicationSalesPaymentAlertEmailTemplate = '<locale en-US="&lt;rule version=&quot;1.0&quot; type=&quot;data&quot;&gt;&amp;lt;data method=&quot;BasicSalesPaymentAlertEmail&quot; version=&quot;1.0&quot;&amp;gt;&#xD;&#xA;  &amp;lt;mailFrom&amp;gt;&amp;lt;/mailFrom&amp;gt;&#xD;&#xA;  &amp;lt;mailTo&amp;gt;&amp;lt;/mailTo&amp;gt;&#xD;&#xA;  &amp;lt;mailBcc&amp;gt;&amp;lt;/mailBcc&amp;gt;&#xD;&#xA;  &amp;lt;subject&amp;gt;[[xsl:value-of select=&quot;in/configuration/generalStoreName&quot; /]] Payment Alert [[[xsl:value-of select=&quot;in/user/username&quot; /]] - Order #[[xsl:value-of select=&quot;in/salesOrder/salesOrderNumber&quot; /]]]&amp;lt;/subject&amp;gt;&#xD;&#xA;  &amp;lt;htmlBody&amp;gt;&amp;amp;lt;table border=&quot;0&quot; cellpadding=&quot;3&quot; cellspacing=&quot;0&quot; style=&quot;width: 100%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;font-size: large;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/configuration/generalStoreName&amp;amp;amp;quot; /]] Payment Alert&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;&amp;amp;amp;nbsp;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;3&quot; style=&quot;width: 100%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Order Number:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/salesOrderNumber&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;PO Number:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/purchaseOrderNumber&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Order Date:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   &amp;amp;amp;nbsp;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;format-dateTime(in/salesOrder/orderDate, &amp;amp;amp;#39;[Y]-[M01]-[D01] [H01]:[m01]&amp;amp;amp;#39;)&amp;amp;amp;quot;/]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   &amp;amp;amp;nbsp;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;vertical-align: top;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Bill To:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingCompany&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingFirstName&amp;amp;amp;quot; /]] [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingLastName&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingStreet&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingCity&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingSubdivisionName&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingPostalCode&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/billingCountryName&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;vertical-align: top;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Ship To:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingCompany&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingFirstName&amp;amp;amp;quot; /]] [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingLastName&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingStreet&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingCity&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingSubdivisionName&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingPostalCode&amp;amp;amp;quot; /]], [[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/shippingCountryName&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;vertical-align: top;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Payment:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:for-each select=&amp;amp;amp;quot;in/salesOrder/salesPayments/salesPayment&amp;amp;amp;quot;]] [[xsl:value-of select=&amp;amp;amp;quot;paymentMethodName&amp;amp;amp;quot;/]]&amp;amp;amp;nbsp;[[xsl:value-of select=&amp;amp;amp;quot;creditCardHint&amp;amp;amp;quot;/]][[xsl:value-of select=&amp;amp;amp;quot;paymentHint&amp;amp;amp;quot;/]][[xsl:value-of select=&amp;amp;amp;quot;voucherHint&amp;amp;amp;quot;/]]&amp;amp;amp;nbsp;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(amount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[/xsl:for-each]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;&amp;amp;amp;nbsp;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;1&quot; cellpadding=&quot;3&quot; cellspacing=&quot;0&quot; style=&quot;width: 100%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 20%;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;SKU&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 40%;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Item&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 15%;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Quantity&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 25%;&quot;&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Amount&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;[[xsl:for-each select=&amp;amp;amp;quot;in/salesOrder/salesOrderDetails/salesOrderDetail[parentSalesOrderDetailID=&amp;amp;amp;#39;&amp;amp;amp;#39;]&amp;amp;amp;quot;]]&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;1&quot; cellpadding=&quot;3&quot; cellspacing=&quot;0&quot; style=&quot;width: 100%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 20%;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;sku&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 40%;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;productName&amp;amp;amp;quot; /]] - [[xsl:value-of select=&amp;amp;amp;quot;productVariantName&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[xsl:for-each select=&amp;amp;amp;quot;salesOrderDetails/salesOrderDetail&amp;amp;amp;quot;]]&amp;amp;amp;nbsp;&amp;amp;amp;nbsp;&amp;amp;amp;nbsp;&amp;amp;amp;nbsp;[[xsl:value-of select=&amp;amp;amp;quot;productName&amp;amp;amp;quot; /]] - [[xsl:value-of select=&amp;amp;amp;quot;productVariantName&amp;amp;amp;quot; /]]: [[xsl:value-of select=&amp;amp;amp;quot;quantity&amp;amp;amp;quot; /]]&amp;amp;lt;br /&amp;amp;gt;&#xD;&#xA;   [[/xsl:for-each]] [[xsl:for-each select=&amp;amp;amp;quot;dynamicFormResult/fields/field&amp;amp;amp;quot;]][[xsl:value-of select=&amp;amp;amp;quot;@id&amp;amp;amp;quot; /]]: [[xsl:value-of select=&amp;amp;amp;quot;.&amp;amp;amp;quot; /]], [[/xsl:for-each]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 15%;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;quantity&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td style=&quot;width: 25%;&quot;&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(combinedAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;[[/xsl:for-each]]&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;p&amp;amp;gt;[[xsl:for-each select=&amp;amp;amp;quot;in/salesOrder/dynamicFormResult/fields/field&amp;amp;amp;quot;]][[xsl:value-of select=&amp;amp;amp;quot;@id&amp;amp;amp;quot; /]]: [[xsl:value-of select=&amp;amp;amp;quot;.&amp;amp;amp;quot; /]], [[/xsl:for-each]]&amp;amp;amp;nbsp;&amp;amp;lt;/p&amp;amp;gt;&#xD;&#xA;&amp;amp;amp;nbsp;&#xD;&#xA;&#xD;&#xA;&amp;amp;lt;table border=&quot;0&quot; cellpadding=&quot;3&quot; cellspacing=&quot;0&quot; style=&quot;width: 30%&quot;&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;tbody&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Discount:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(sum(in/salesOrder/salesOrderDetails/salesOrderDetail/discountAmount) * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Sub-Total:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/subTotalAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Shipping:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/shippingAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Handling:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/handlingAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Taxes:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number((in/salesOrder/taxAmount1 + in/salesOrder/taxAmount2 + in/salesOrder/taxAmount3 + in/salesOrder/taxAmount4 + in/salesOrder/taxAmount5) * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Total:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number(in/salesOrder/totalAmount * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Total Savings:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;/in/salesOrder/currency/currencySymbol&amp;amp;amp;quot; /]][[xsl:value-of select=&amp;amp;amp;quot;format-number((sum(in/salesOrder/salesOrderDetails/salesOrderDetail/discountAmount) + in/salesOrder/handlingDiscountAmount + in/salesOrder/shippingDiscountAmount + in/salesOrder/taxDiscountAmount) * /in/salesOrder/exchangeRate, &amp;amp;amp;#39;#,##0.00&amp;amp;amp;#39;)&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;tr&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;&amp;amp;lt;strong&amp;amp;gt;Points earned:&amp;amp;lt;/strong&amp;amp;gt;&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;   &amp;amp;lt;td&amp;amp;gt;[[xsl:value-of select=&amp;amp;amp;quot;in/salesOrder/rewardsPointsQualified&amp;amp;amp;quot; /]]&amp;amp;lt;/td&amp;amp;gt;&#xD;&#xA;  &amp;amp;lt;/tr&amp;amp;gt;&#xD;&#xA; &amp;amp;lt;/tbody&amp;amp;gt;&#xD;&#xA;&amp;amp;lt;/table&amp;amp;gt;&#xD;&#xA;&amp;lt;/htmlBody&amp;gt;&#xD;&#xA;&amp;lt;/data&amp;gt;&lt;/rule&gt;" />'

	COMMIT TRANSACTION
END TRY
BEGIN CATCH
	DECLARE @errorMessage NVARCHAR(4000)
	DECLARE @errorSeverity INT
	DECLARE @errorState INT

	SELECT @errorMessage = ERROR_MESSAGE(), @errorSeverity = ERROR_SEVERITY(), @errorState = ERROR_STATE()
	RAISERROR (@errorMessage, @errorSeverity, @errorState)
END CATCH
GO