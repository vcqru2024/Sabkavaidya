@using System.Collections.Specialized;
@using DotNetNuke.Entities.Users;
@using DotNetNuke.Services.Localization;
@using Revindex.Business.Revindex.Revindex.Storefront;
@using Revindex.Data.Dnn;
@using Revindex.Dnn.RevindexStorefront.Pages;
@using Revindex.Dnn;
@using Revindex.Web.Mvc.Dnn.Helpers;
@using Revindex.Web.UI.DynamicControls;
@inherits Revindex.Dnn.RevindexStorefront.Views.ClientSideWebViewPage

<div id="rvdsfSalesRegisterContainer" class="rvd-module-container rvdsf rvdsf-salesregister-container modal-fullscreen modal fade">
    <div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-body">
	            <div id="rvdsfSalesRegisterMessage" style="display:none"></div>
                <div class="hidden" data-bind="css: { hidden: false }, if: IsUserAuthorized()">
	                <div class="row">
		                <div class="col-sm-7">
			                <h2>
                                <!-- ko ifnot: SalesOrderSet.SalesOrder -->
				                @Html.LocalizeString("SalesRegisterHeader")
                                <!-- /ko -->
				                <!-- ko if: SalesOrderSet.SalesOrder -->
				                # <span data-bind="text: SalesOrderSet.SalesOrder().SalesOrderNumber"></span>
				                <span style="margin-left: 20px; color: #999">@Html.LocalizeString("TotalLabel")</span> <span data-bind="text: SalesOrderSet.FormattedTotalAmount"></span> <span class="badge badge-default" data-bind="text: SalesOrderSet.MainSalesOrderDetails().map(sod => sod.Quantity()).reduce((accumulator, currentValue) => accumulator + currentValue, 0)"></span>
				                <!-- /ko -->
			                </h2>
		                </div>
		                <div class="col-sm-5 text-right">
                            <button type="button" class="btn btn-link btn-lg" data-bind="click: showSession"><em class="glyphicon glyphicon-remove fa fas fa-times"></em></button>
                            <button type="button" class="btn btn-link btn-lg" data-bind="click: showSettings"><em class="glyphicon glyphicon-cog fa fas fa-cog"></em></button>
                            <button type="button" class="btn btn-link btn-lg" data-bind="click: toggleFullscreen" onclick3="if (document.fullscreenElement) { document.exitFullscreen(); $('#rvdsfSalesRegisterContainer').removeClass('rvdsf-fullscreen'); } else { $('#rvdsfSalesRegisterContainer').get(0).requestFullscreen(); $('#rvdsfSalesRegisterContainer').addClass('rvdsf-fullscreen'); }"><em class="glyphicon glyphicon-fullscreen fas fa fa-expand"></em></button>
                            <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: showSalesOrders">@Html.LocalizeString("SalesOrdersLink")</button>
                            <button type="button" class="btn btn-primary btn-lg" data-bind="click: createSalesOrder">@Html.LocalizeString("AddNewLink")</button>
		                </div>
	                </div>
                    <!-- ko if: SalesOrderSet.SalesOrder -->
                    <div class="row rvdsf-actionbar-container">
                        <div class="col-sm-7">
                            <button type="button" class="btn btn-link btn-lg" data-bind="click: showCustomer">@Html.LocalizeString("CustomerLink")</button>
                            <button type="button" class="btn btn-link btn-lg" data-bind="click: showBilling">@Html.LocalizeString("BillingLink")</button>
                            <button type="button" class="btn btn-link btn-lg" data-bind="click: showShipping">@Html.LocalizeString("ShippingLink")</button>
                            <button type="button" class="btn btn-link btn-lg" data-bind="click: showNotes">@Html.LocalizeString("NotesLink") <span class="badge badge-default" data-bind="visible: SalesOrderSet.AdminNotes">!</span></button>
                        </div>
                        <div class="col-sm-2">
                            <button type="button" class="btn btn-link btn-lg" ><span data-bind="attr: { class: 'badge rvdsf-salesorder-status-' + SalesOrderSet.SalesOrder().Status()}" >&nbsp;</span> <span data-bind="text: SalesOrderSet.SalesOrder().StatusName"></span></button>
                        </div>
                        <div class="col-sm-3 text-right">
                            <div class="dropdown">
                                <button class="btn btn-link btn-lg dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span style="color: #999">@Html.LocalizeString("BalanceLabel")</span> <span data-bind="text: SalesOrderSet.FormattedBalance"></span>
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-right">
                                    <li><button class="btn btn-link btn-lg" type="button"><span style="color: #999">@Html.LocalizeString("SavingsLabel")</span> <span data-bind="text: SalesOrderSet.FormattedTotalSavingsAmount"></span></button></li>
                                    <li><button class="btn btn-link btn-lg" type="button"><span style="color: #999">@Html.LocalizeString("SubTotalLabel")</span> <span data-bind="text: SalesOrderSet.FormattedSubTotalAmount"></span></button></li>
                                    <li><button class="btn btn-link btn-lg" type="button"><span style="color: #999">@Html.LocalizeString("TaxLabel")</span> <span data-bind="text: SalesOrderSet.FormattedTotalTaxAmount"></span></button></li>
                                    <li><button class="btn btn-link btn-lg" type="button"><span style="color: #999">@Html.LocalizeString("PaymentsLabel")</span> <span data-bind="text: SalesOrderSet.FormattedTotalPaymentReceived"></span></button></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr />
	                <div class="row">
                        <div class="col-sm-7">
                            <div class="row" style="margin-bottom: 20px">
                                <div class="col-sm-2">
                                    <div class="dropdown">
                                        <button class="btn btn-default btn-light btn-lg dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                            <em class="glyphicon glyphicon-menu-hamburger fa fas fa-bars"></em>
                                        </button>
                                        <ul class="dropdown-menu" data-bind="foreach: { data: CategoryOptions, as: 'category' }" style="max-height: 50vh; overflow-y: auto;">
					                        <li>
						                        <a href="#" data-bind="text: category.Name, click: function() { $root.SelectedCategory(category.CategoryID);  $root.listProducts(); }"></a>
					                        </li>
				                        </ul>
                                    </div>
                                </div>
				                <div class="col-sm-10">
					                <div class="input-group">
						                <input id="rvdsfProductSearchQueryInput" type="search" class="form-control input-lg" placeholder="@Html.LocalizeString("ProductQueryPlaceholder")" onkeypress="if (event.keyCode == '13') { event.preventDefault(); $('#rvdsfProductSearchButton').click(); }" onclick="this.select()" />
						                <div class="input-group-btn input-group-append">
							                <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: resetProducts" onclick="$('#rvdsfProductSearchQueryInput').focus()"><em class="glyphicon glyphicon-remove fa fas fa-times"></em></button>
							                <button id="rvdsfProductSearchButton" type="button" class="btn btn-primary btn-lg" data-bind="click: searchProducts"><em class="glyphicon glyphicon-search fa fas fa-search"></em></button>
						                </div>
					                </div>
				                </div>
			                </div>
			                <div id="rvdsfProductSearchSalesRegisterContainer" class="row rvdsf-salesregister-productsearch-container" style="height: 52vh; overflow: auto;" data-bind="foreach: { data: Products, as: 'product' }">
                                <!-- ko foreach: { data: ProductVariants, as: 'productVariant' } -->
                                    <!-- ko if: productVariant.RecurringInterval == 0 && !productVariant.HasFormFields && productVariant.SalesType == 1 -->
				                        <div class="col-sm-3" style="padding: 0 5px;">
                                            <div class="thumbnail" data-bind="click: function() { if ($root.SalesOrderSet.SalesOrder() && $root.SalesOrderSet.SalesOrder().Status() == 7) $root.addProductToCart(productVariant.ProductVariantID, 1) }">
                                                <!-- ko if: productVariant.MainThumbnailGallery -->
								                    <img class="img-responsive img-fluid" data-bind="attr: { src: productVariant.MainThumbnailGallery.MediaUrl }" loading="lazy" />
							                    <!-- /ko -->
                                                <!-- ko ifnot: productVariant.MainThumbnailGallery -->
								                    <img class="img-responsive img-fluid" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
							                    <!-- /ko -->
                                                <div class="caption">
                                                    <a data-bind="text: product.Name, attr: { href: productVariant.Administration.TabUrl }"></a><br />
								                    <span data-bind="text: productVariant.Name"></span><br/>
                                                    <small data-bind="text: productVariant.UniversalProductCode" class="text-muted"></small><br/>
                                                    <span data-bind="text: productVariant.FormattedCombinedSellingPrice"></span>
                                                </div>
                                            </div>
				                        </div>
                                    <!-- /ko -->
                                <!-- /ko -->
			                </div>
                        </div>
                        <div class="col-sm-5" style="border-left: solid 1px #eee;">
                            <div id="rvdsfSalesOrderDetailsSalesRegisterContainer" class="table-responsive" style="height: 60vh; overflow-y: auto;">
					            <table class="table table-striped table-hover">
						            <tbody data-bind="foreach: { data: SalesOrderSet.MainSalesOrderDetails, as: 'sod' }">
							            <tr data-bind="click: function() { if ($root.SalesOrderSet.SalesOrder() && $root.SalesOrderSet.SalesOrder().Status() == 7) $root.showSalesOrderDetail(sod);}" style="cursor: pointer">
								            <td class="col-xs-2" data-bind="if: sod.ProductVariant.MainThumbnailGallery">
									            <img class="img-responsive img-fluid" data-bind="attr: { src: sod.ProductVariant.MainThumbnailGallery.MediaUrl }" loading="lazy" />
								            </td>
								            <td>
									            <a data-bind="click: function() { if ($root.SalesOrderSet.SalesOrder() && $root.SalesOrderSet.SalesOrder().Status() == 7) $root.showSalesOrderDetail(sod);}, text: sod.ProductName, attr: { href: sod.ProductVariant.Administration.TabUrl }"></a><br />
									            <span data-bind="text: sod.ProductVariantName"></span><br/>
                                                <small data-bind="text: sod.ProductVariant.UniversalProductCode" class="text-muted"></small>
								            </td>
								            <td class="col-xs-2" style="text-align:center">
									            <span data-bind="text: sod.FormattedCombinedTotalAmount"></span><br />
									            <span class="badge badge-secondary" data-bind="text: sod.Quantity"></span>
								            </td>
								            <td class="col-xs-1"><button type="button" class="btn btn-default btn-light btn-lg" data-bind="disable: $root.SalesOrderSet.SalesOrder() && $root.SalesOrderSet.SalesOrder().Status() != 7, click: function() { event.stopPropagation(); $root.removeSalesOrderDetail(sod.SalesOrderDetailID()) }"><em class="glyphicon glyphicon-remove fa fas fa-times"></em></button></td>
							            </tr>
						            </tbody>
					            </table>
				            </div>
                        </div>
                    </div>
	                <div class="row rvdsf-footerbar-container" style="margin-bottom: 0; padding-bottom: 0;">
		                <div class="col-sm-6">
                            <!-- ko if: SalesOrderSet.MainSalesOrderDetails() > 0 -->
			                <button type="button" class="btn btn-default btn-light btn-lg" data-bind="visible: SalesOrderSet.SalesOrder">@Html.LocalizeString("ClearCartLink")</button>
                            <!-- /ko -->
                            <!-- ko if: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7 -->
			                <button type="button" class="btn btn-default btn-lg" data-bind="visible: PrinterConnected, click: openDrawer">@Html.LocalizeString("OpenDrawerLink")</button>
			                <button type="button" class="btn btn-primary btn-lg" data-bind="click: emailReceipt">@Html.LocalizeString("EmailLink")</button>
			                <button type="button" class="btn btn-primary btn-lg" data-bind="visible: PrinterConnected, click: printReceipt">@Html.LocalizeString("PrintLink")</button>
                            <!-- /ko -->
		                </div>
		                <div class="col-sm-6 text-sm-right">
                            <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: showCoupons">@Html.LocalizeString("CouponsLink") <span class="badge badge-default" data-bind="visible: SalesOrderSet.CouponCodeList().length > 0, text: SalesOrderSet.CouponCodeList().length"></span></button>
			                <button type="button" class="btn btn-primary btn-lg" data-bind="visible: SalesOrderSet.SalesOrder, click: showSalesPayments">@Html.LocalizeString("PaymentsLink") <span class="badge badge-default" data-bind="visible: SalesOrderSet.SalesPayments().length > 0, text: SalesOrderSet.SalesPayments().length"></span></button>
                            <button type="button" class="btn btn-primary btn-lg" data-bind="visible: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() == 7, disable: SalesOrderSet.BalanceDue() > 0.02, click: placeOrder">@Html.LocalizeString("PlaceOrderLink")</button>
		                </div>
	                </div>
                    <!-- /ko -->
                    <!-- ko ifnot: SalesOrderSet.SalesOrder -->
                    <hr>
                    <div class="rvdsf-startup-container text-muted" ><em class="glyphicon glyphicon-bell fa fas fa-bell" style="font-size: 20vh"></em><h3>@Html.LocalizeString("StartupLabel")</h3></div>
                    <!-- /ko -->
                </div>
                <div class="hidden" data-bind="css: { hidden: false }, ifnot: IsUserAuthorized()">
                    <h2>@Html.LocalizeString("SalesRegisterHeader")</h2>
                    <hr/>
                    <div style="margin: 60px;">
                    <!-- ko if: IsInUse() -->
                        <div class="alert alert-warning">@Html.LocalizeString("SessionLockedLabel")</div>
                        @if (Dnn.User.IsSuperUser || Dnn.User.IsInRole("Administrators")) 
                        { 
                            <button type="button" class="btn btn-primary btn-lg" data-bind="click: showSession">@Html.LocalizeString("CloseSalesRegisterLink")</button>
                        }
                    <!-- /ko -->
                    <!-- ko ifnot: IsInUse() -->
                        <div class="row">
                            <div class="col-sm-offset-3 col-sm-6">
                                <div class="form-group">
					                <label for="rvdsfStartCashSalesRegisterInput">@Html.LocalizeString("StartCashLabel")</label>
                                    <input type="number" class="form-control input-lg" id="rvdsfStartCashSalesRegisterInput" value="0.00" onclick="this.select()">
				                </div>
                                <div class="form-group">
					                <button type="button" class="btn btn-primary btn-lg btn-block" data-bind="click: startSalesRegister">@Html.LocalizeString("StartSalesRegisterLink")</button>
				                </div>
                            </div>
                        </div>
                    <!-- /ko -->
                    </div>
                </div>

                <div id="rvdsfBillingSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog modal-lg" role="document">
		                <div class="modal-content" id="rvdsfBillingSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("BillingHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <div class="row">
                                    <div class="col-sm-6">
						                <div class="form-group">
							                <label for="rvdsfBillingNameSalesRegisterInput">@Html.LocalizeString("BillingFirstNameLabel")</label>
							                <input type="text" class="form-control input-lg" id="rvdsfBillingFirstNameSalesRegisterInput" data-bind="value: SalesOrderSet.BillingFirstName">
						                </div>
                                        <div class="form-group">
							                <label for="rvdsfBillingNameSalesRegisterInput">@Html.LocalizeString("BillingLastNameLabel")</label>
							                <input type="text" class="form-control input-lg" id="rvdsfBillingLastNameSalesRegisterInput" data-bind="value: SalesOrderSet.BillingLastName">
						                </div>
                                        <div class="form-group">
						                    <label>@Html.LocalizeString("BillingCompanyLabel")</label>
						                    <input name="rvdsfBillingCompanySalesRegisterInput" type="text" maxlength="100" class="form-control input-lg" data-bind="value: SalesOrderSet.BillingCompany" />
					                    </div>
                                        <div class="form-group">
							                <label for="rvdsfBillingEmailSalesRegisterInput">@Html.LocalizeString("BillingEmailLabel")</label>
							                <input type="email" class="form-control input-lg" id="rvdsfBillingEmailSalesRegisterInput" data-bind="value: SalesOrderSet.BillingEmail">
						                </div>
						                <div class="form-group">
							                <label for="rvdsfBillingPhoneSalesRegisterInput">@Html.LocalizeString("BillingPhoneLabel")</label>
							                <input type="tel" class="form-control input-lg" id="rvdsfBillingPhoneSalesRegisterInput" data-bind="value: SalesOrderSet.BillingPhone">
						                </div>
                                        <div class="form-group">
							                <label for="rvdsfBillingPhoneSalesRegisterInput">@Html.LocalizeString("BusinessTaxNumberLabel")</label>
							                <input type="tel" class="form-control input-lg" id="rvdsfBusinessTaxNumberSalesRegisterInput" data-bind="value: SalesOrderSet.BusinessTaxNumber">
						                </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="form-group">
						                    <label class="required">@Html.LocalizeString("BillingCountryLabel")</label>
						                    <select class="form-control input-lg" required data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" data-bind="options: BillingCountries, optionsText: 'Name', optionsValue: 'IsoAlpha2Code', value: SalesOrderSet.BillingCountryCode, event: { blur: billingCountryChanged }" ></select>
					                    </div>
                                        <div class="form-group">
						                    <label>@Html.LocalizeString("BillingStreetLabel")</label>
						                    <input type="text" name="rvdsfBillingStreetSalesRegisterInput" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" maxlength="200" class="form-control input-lg" data-bind="value: SalesOrderSet.BillingStreet" placeholder="@Html.LocalizeString("StreetPlaceHolder")" />
					                    </div>
					                    <div class="form-group">
                                            <label></label>
						                    <input type="text" name="rvdsfBillingUnitSalesRegisterInput" maxlength="200" class="form-control input-lg" data-bind="value: SalesOrderSet.BillingUnit" placeholder="@Html.LocalizeString("UnitPlaceHolder")" />
					                    </div>
					                    <div class="form-group" data-bind="visible: BillingDistrictRequired()" >
						                    <label>@Html.LocalizeString("BillingDistrictLabel")</label>
						                    <input type="text" name="rvdsfBillingDistrictSalesRegisterInput" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" maxlength="50" class="form-control input-lg" data-bind="value: SalesOrderSet.BillingDistrict" />
					                    </div>
					                    <div class="form-group">
						                    <label>@Html.LocalizeString("BillingCityLabel")</label>
						                    <input name="rvdsfBillingCitySalesRegisterInput" type="text" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" maxlength="50" class="form-control input-lg" data-bind="value: SalesOrderSet.BillingCity" />
					                    </div>
                                        <!-- ko if: BillingSubdivisions().length > 1 -->
                                        <div class="form-group">
						                    <label class="required">@Html.LocalizeString("BillingSubdivisionLabel")</label>
						                    <select class="form-control input-lg" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" data-bind="options: BillingSubdivisions, optionsText: 'Name', optionsValue: 'IsoCode', value: SalesOrderSet.BillingSubdivisionCode, valueAllowUnset: true, event: { blur: shippingAddressChanged }" required ></select>
					                    </div>
                                        <!-- /ko -->
                                        <div class="form-group">
							                <label for="rvdsfBillingPostalCodeSalesRegisterInput">@Html.LocalizeString("BillingPostalCodeLabel")</label>
							                <input type="text" class="form-control input-lg" id="rvdsfBillingPostalCodeSalesRegisterInput" data-bind="value: SalesOrderSet.BillingPostalCode">
						                </div>
                                    </div>
                                </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: copyProfileToBilling">@Html.LocalizeString("CopyProfileLink")</button>
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: copyShipping">@Html.LocalizeString("CopyShippingLink")</button>
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: cancelBilling">@Html.LocalizeString("CancelLink")</button>
                                        <button type="button" class="btn btn-primary btn-lg" data-bind="disable: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7, click: saveBilling">@Html.LocalizeString("SaveLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfCouponsSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog" role="document">
		                <div class="modal-content" id="rvdsfCouponsSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("CouponHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <div class="alert alert-danger" data-bind="visible: CouponError, text: CouponError"></div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="form-group">
                                            <div class="input-group">
							                    <input id="rvdsfCouponSalesRegisterInput" type="search" class="form-control input-lg" onkeypress="if (event.keyCode == '13') { event.preventDefault(); $('#rvdsfAddCouponSalesRegisterButton').click(); }" onclick="this.select()" />
							                    <div class="input-group-btn input-group-append">
								                    <button id="rvdsfAddCouponSalesRegisterButton" type="button" class="btn btn-primary btn-lg" data-bind="disable: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7, click: function() { $root.addCoupon($('#rvdsfCouponSalesRegisterInput').val()); $('#rvdsfCouponSalesRegisterInput').val(''); }">@Html.LocalizeString("SaveCouponLink")</button>
							                    </div>
						                    </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="form-group">
                                            <!-- ko foreach: SalesOrderSet.CouponCodeList -->
                                                <button type="button" class="btn btn-default btn-light btn-lg" data-bind="disable: $root.SalesOrderSet.SalesOrder() && $root.SalesOrderSet.SalesOrder().Status() != 7, click: function() { $root.removeCoupon($data) }"><span data-bind="text: $data"></span> <em class="glyphicon glyphicon-remove fa fas fa-trash"></em></button>
                                            <!-- /ko -->
                                        </div>
                                    </div>
                                </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-primary btn-lg" onclick="$('#rvdsfCouponsSalesRegisterModal').modal('hide')">@Html.LocalizeString("CloseLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfCustomerSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog" role="document">
		                <div class="modal-content" id="rvdsfCustomerSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("CustomerHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <div class="alert alert-danger" data-bind="visible: CustomerError, text: CustomerError"></div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="form-group">
                                            <label>@Html.LocalizeString("UsernameLabel")</label>
                                            <input type="number" class="form-control input-lg" id="rvdsfUserIDSalesRegisterInput" data-bind="value: SalesOrderSet.Customer.Username"/>
                                            <script>
                                                $(document).ready(function () {
                                                    $('#rvdsfUserIDSalesRegisterInput').kendoComboBox({
                                                        dataTextField: "Username",
                                                        dataValueField: "UserID",
                                                        filter: "contains",
                                                        autoBind: false,
                                                        minLength: 2,
                                                        clearButton: true,
                                                        placeholder: '@Html.LocalizeString("UsernamePlaceholder")',
                                                        template: '<span class="k-state-default" style="background-image: url(\'#: data.Profile.PhotoURL #\')"></span>' +
                                                                    '<span class="k-state-default"><strong>#: data.DisplayName #</strong><p>#: data.Email #</p></span>',
                                                        change: function (e) {
                                                            if (this.dataItem()) {
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.UserID(this.dataItem().UserID)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.Username(this.dataItem().Username)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.FirstName(this.dataItem().FirstName)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.LastName(this.dataItem().LastName)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.Email(this.dataItem().Email)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.Phone(this.dataItem().Profile.Telephone)
                                                            }
                                                            else {
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.UserID(null)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.Username(null)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.FirstName(null)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.LastName(null)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.Email(null)
                                                                salesRegisterContainer.viewModel.SalesOrderSet.Customer.Phone(null)
                                                            }

                                                            // Reset validation styles
                                                            $('#rvdsfCustomerSalesRegisterContainer div.form-group').removeClass('has-error');
                                                            $('#rvdsfCustomerSalesRegisterContainer input').removeClass('is-invalid');
                                                            $('#rvdsfCustomerSalesRegisterContainer .help-block').hide()
                                                        },
                                                        dataSource: new kendo.data.DataSource({
									                        serverFiltering: true,
									                        serverPaging: true,
									                        pageSize: 50,
									                        transport: {
										                        read: {
											                        type: 'POST',
											                        url: function () { return servicesFramework.getServiceRoot('Revindex.Dnn.RevindexStorefront') + 'User/Lookup' },
											                        beforeSend: servicesFramework.setModuleHeaders,
											                        dataType: 'json',
											                        contentType: 'application/json; charset=UTF-8'
										                        },
                                                                parameterMap: function (data, type) {
											                        return kendo.stringify({
												                        Query: data.filter && data.filter.filters.length > 0 ? data.filter.filters[0].value : '',
												                        ItemIndex: 0,
												                        MaxItems: data.pageSize
											                        })
										                        }
									                        },
									                        sort: [{ field: 'DisplayName', dir: 'asc' }]
								                        })
                                                    })
                                                })
                                            </script>
                                        </div>
                                        <!-- ko ifnot: SalesOrderSet.Customer.UserID -->
                                            <div>
                                                <button type="button" class="btn btn-lg btn-default btn-light" data-bind="click: copyFirstName">@Html.LocalizeString("CopyFirstNameLink")</button>
                                                <button type="button" class="btn btn-lg btn-default btn-light" data-bind="click: copyLastName">@Html.LocalizeString("CopyLastNameLink")</button>
                                                <button type="button" class="btn btn-lg btn-default btn-light" data-bind="click: copyEmail">@Html.LocalizeString("CopyEmailLink")</button>
                                            </div>
                                        <!-- /ko -->
                                        <hr />
                                        <div class="form-group">
                                            <label class="required">@Html.LocalizeString("FirstNameLabel")</label>
                                            <input type="text" class="form-control input-lg" required data-bind="value: SalesOrderSet.Customer.FirstName, disable: SalesOrderSet.Customer.UserID">
                                        </div>
                                        <div class="form-group">
                                            <label class="required">@Html.LocalizeString("LastNameLabel")</label>
                                            <input type="text" class="form-control input-lg" required data-bind="value: SalesOrderSet.Customer.LastName, disable: SalesOrderSet.Customer.UserID">
                                        </div>
                                        <div class="form-group">
                                            <label class="required">@Html.LocalizeString("EmailLabel")</label>
                                            <input type="email" class="form-control input-lg" required data-bind="value: SalesOrderSet.Customer.Email, disable: SalesOrderSet.Customer.UserID">
                                        </div>
                                        <div class="form-group">
                                            <label>@Html.LocalizeString("PhoneLabel")</label>
                                            <input type="tel" class="form-control input-lg" data-bind="value: SalesOrderSet.Customer.Phone, disable: SalesOrderSet.Customer.UserID">
                                        </div>
                                    </div>
                                </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: cancelCustomer">@Html.LocalizeString("CancelLink")</button>
                                        <button type="button" class="btn btn-primary btn-lg" data-bind="disable: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7, click: saveCustomer">@Html.LocalizeString("SaveLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfNotesSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog modal-lg" role="document">
		                <div class="modal-content" id="rvdsfNotesSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("NotesHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <div id="rvdsfAdminNotesSalesRegisterContainer"></div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: cancelNotes">@Html.LocalizeString("CancelLink")</button>
                                        <button type="button" class="btn btn-primary btn-lg" data-bind="disable: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7, click: saveNotes">@Html.LocalizeString("SaveLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfSalesOrderDetailSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog" role="document">
		                <div class="modal-content" id="rvdsfSalesOrderDetailSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("SalesOrderDetailHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <div class="alert alert-danger" data-bind="visible: SalesOrderDetailError, text: SalesOrderDetailError"></div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <!-- ko if: SalesOrderDetail -->
                                        <div class="form-group">
                                            <label class="required">@Html.LocalizeString("QuantityLabel")</label>
                                            <!-- ko if: SalesOrderDetail().ProductVariant.AllowableOrderQuantityList().length == 0 -->
						                    <input required class="form-control input-lg" type="number" data-bind="value: SalesOrderDetailQuantity, attr: {'readonly': $root.SalesOrderSet.OrderLocked(), 'min': SalesOrderDetail().ProductVariant.MinOrderQuantity() == null ? SalesOrderDetail().ProductVariant.DefaultQuantity() : SalesOrderDetail().ProductVariant.MinOrderQuantity(), 'max': SalesOrderDetail().ProductVariant.MaxOrderQuantity() == null ? 9999 : SalesOrderDetail().ProductVariant.MaxOrderQuantity() }" step="1" onchange="if (this.value == '') this.value = this.min; else if (parseInt(this.value) > this.max) this.value = this.max; else if (parseInt(this.value) < this.min) this.value = this.min;" onkeypress="return event.charCode >= 48 && event.charCode <= 57" onclick="this.select()"/>
						                    <!-- /ko -->
						                    <!-- ko ifnot: SalesOrderDetail().ProductVariant.AllowableOrderQuantityList().length == 0 -->
						                    <select required class="form-control input-lg" data-bind="value: SalesOrderDetailQuantity, options: SalesOrderDetail().ProductVariant.AllowableOrderQuantityList, attr: {'readonly': $root.SalesOrderSet.OrderLocked() }"></select>
						                    <!-- /ko -->
                                        </div>
                                        <!-- /ko -->
                                    </div>
                                </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                            
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-primary btn-lg" data-bind="click: saveSalesOrderDetail">@Html.LocalizeString("CloseLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfSalesOrdersSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog modal-lg" role="document">
		                <div class="modal-content" id="rvdsfSalesOrdersSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("OpenHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <div class="input-group" style="margin: 20px 20px">
						            <input id="rvdsfSalesOrderNumberInput" type="search" class="form-control input-lg" placeholder="@Html.LocalizeString("SalesOrderNumberPlaceholder")" onkeypress="if (event.keyCode == '13') { event.preventDefault(); $('#rvdsfOpenSalesOrderSalesRegisterButton').click(); }" onclick="this.select()" />
						            <div class="input-group-btn input-group-append">
							            <button id="rvdsfOpenSalesOrderSalesRegisterButton" type="button" class="btn btn-primary btn-lg" data-bind="click: function() { $root.loadSalesOrder($('#rvdsfSalesOrderNumberInput').val()); $root.hideSalesOrders(); }">@Html.LocalizeString("OpenSalesOrderLink")</button>
						            </div>
					            </div>
                                <hr>
                                <div class="table-responsive" style="height: 40vh; overflow: auto;">
						            <table class="table table-striped table-hover">
							            <tbody data-bind="foreach: { data: RecentOrders, as: 'so' }">
								            <tr data-bind="click: function() { $root.loadSalesOrder(so.SalesOrder().SalesOrderNumber()); $root.hideSalesOrders(); }" style="cursor: pointer">
									            <td><a class="btn btn-link" href="#" data-bind="click: function() { $root.loadSalesOrder(so.SalesOrder().SalesOrderNumber()); $root.hideSalesOrders(); }, text: so.SalesOrder().SalesOrderNumber" onclick="event.stopPropagation()"></a></td>
									            <td data-bind="text: so.FormattedOrderDate"></td>
									            <td><span data-bind="text: so.SalesOrder().StatusName, attr: { class: 'badge badge-default rvdsf-badge rvdsf-salesorder-status-' + so.SalesOrder().Status()}"></span></td>
									            <td><span data-bind="text: so.BillingFirstName"></span> <span data-bind="text: so.BillingLastName"></span></td>
									            <td data-bind="text: so.FormattedTotalAmount"></td>
								            </tr>
							            </tbody>
						            </table>
					            </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-primary btn-lg" onclick="$('#rvdsfSalesOrdersSalesRegisterModal').modal('hide')">@Html.LocalizeString("CloseLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfSalesPaymentsSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog modal-lg" role="document">
		                <div class="modal-content" id="rvdsfSalesPaymentsSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("SalesPaymentsHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <style>
                                    /* DNN adds extra tags to the radio buttons that breaks the design */
						            #rvdsfSalesPaymentsSalesRegisterContainer span.dnnRadiobutton {
							            display: none;
						            }
                                </style>
                                <div class="alert alert-danger" data-bind="visible: SalesPaymentError, text: SalesPaymentError"></div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="form-group">
						                    <label>@Html.LocalizeString("PaymentMethodLabel")</label>
                                            <div>
                                                <div class="btn-group" data-toggle="buttons" data-bind="foreach: { data: AvailablePaymentMethods, as: 'pm' }">
                                                    <button type="button" class="btn btn-default btn-light btn-lg" data-bind="css: { active: $root.PrimaryPaymentMethod() == PaymentMethod() }, text: PaymentMethodName, click: function() { $root.PrimaryPaymentMethod(pm.PaymentMethod()); }"></button>
                                                </div>
                                            </div>
					                    </div>
                                        <div class="form-group" data-bind="visible: $root.PrimaryPaymentMethod() == 10">
						                    <label class="required">@Html.LocalizeString("VoucherCodeLabel")</label>
						                    <input type="text" required data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" class="form-control input-lg" data-bind="value: VoucherCode" onclick="this.select()" />
					                    </div>
                                        <div class="form-group" data-bind="visible: $root.PrimaryPaymentMethod() != 10">
						                    <label class="required">@Html.LocalizeString("AmountLabel")</label>
						                    <input type="number" required data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" class="form-control input-lg" data-bind="textInput: PaymentAmount" onclick="this.select()" />
					                    </div>
                                        <div class="form-group" data-bind="visible: $root.PrimaryPaymentMethod() == 1 && PaymentAmount() > SalesOrderSet.BalanceDue()">
						                    <label>@Html.LocalizeString("ChangeDueLabel")</label>
						                    <h4 class="alert alert-success" data-bind="text: formatCurrency(PaymentAmount() - SalesOrderSet.BalanceDue())"></h4>
					                    </div>
                                    </div>
                                </div>
                                <hr />
                                <div class="table-responsive" style="height: 25vh; overflow: auto;">
						            <table class="table table-striped table-hover">
							            <tbody data-bind="foreach: { data: SalesOrderSet.SalesPayments, as: 'sp' }">
								            <tr>
									            <td data-bind="text: moment(sp.PaymentDate()).format('YYYY-MM-DD')"></td>
                                                <td><span data-bind="text: sp.PaymentMethodName"></span><br/><span class="badge badge-default" data-bind="text: sp.FormattedHint"></span></td>
									            <td><span data-bind="text: sp.TransactionTypeName"></span><br/><span class="badge badge-default" data-bind="text: sp.PaymentGatewayResponseCodeName"></span></td>
									            <td data-bind="text: sp.FormattedAmount"></td>
								            </tr>
							            </tbody>
						            </table>
					            </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-3 text-left">
                                        <button type="button" class="btn btn-default btn-lg" data-bind="visible: PrinterConnected, click: openDrawer">@Html.LocalizeString("OpenDrawerLink")</button>
                                    </div>
                                    <div class="col-sm-9">
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: cancelSalesPayments">@Html.LocalizeString("CancelLink")</button>
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="disable: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7, click: manualAuthorize">@Html.LocalizeString("AuthorizeLink")</button>
                                        <button type="button" class="btn btn-primary btn-lg" data-bind="disable: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7, click: manualPurchase">@Html.LocalizeString("PurchaseLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfSessionSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog" role="document">
		                <div class="modal-content" id="rvdsfSessionSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("SessionHeader")</h4>
			                </div>
			                <div class="modal-body form-horizontal">
                                <div class="form-group">
                                    <label class="col-xs-offset-3 col-xs-3 control-label text-right">@Html.LocalizeString("OperatorLabel")</label>
                                    <div class="col-xs-6 text-left form-control-static" data-bind="text: getSalesRegisterOperatorUserID()"></div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-offset-3 col-xs-3 control-label text-right">@Html.LocalizeString("SessionStartLabel")</label>
                                    <div class="col-xs-6 text-left form-control-static" data-bind="text: getSalesRegisterStartDate()"></div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-offset-3 col-xs-3 control-label text-right">@Html.LocalizeString("SessionStopLabel")</label>
                                    <div class="col-xs-6 text-left form-control-static" data-bind="text: new moment().format('YYYY-MM-DD HH:mm:ss')"></div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-offset-3 col-xs-3 control-label text-right">@Html.LocalizeString("CashStartLabel")</label>
                                    <div class="col-xs-6 text-left form-control-static" data-bind="text: formatCurrency(getSalesRegisterStartCash())"></div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-offset-3 col-xs-3 control-label text-right">@Html.LocalizeString("CashStopLabel")</label>
                                    <div class="col-xs-6 text-left form-control-static" data-bind="text: formatCurrency(getSalesRegisterStopCash())"></div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-offset-3 col-xs-3 control-label text-right">@Html.LocalizeString("CashReceivedLabel")</label>
                                    <div class="col-xs-6 text-left form-control-static" data-bind="text: formatCurrency(getSalesRegisterStopCash() - getSalesRegisterStartCash())">TODO: $500.00</div>
                                </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
				                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="visible: PrinterConnected, click: printSummary">@Html.LocalizeString("PrintLink")</button>
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">@Html.LocalizeString("CancelLink")</button>
                                        <button type="button" class="btn btn-primary btn-lg" data-bind="click: stopSalesRegister" >@Html.LocalizeString("StopSalesRegisterLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfSettingsSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog" role="document">
		                <div class="modal-content" id="rvdsfSettingsSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("SettingsLabel")</h4>
			                </div>
			                <div class="modal-body">
                                <div class="form-group">
					                <label>@Html.LocalizeString("SalesRegisterKeyLabel")</label>
                                    <div class="form-control-static" data-bind="text: SalesRegisterKey"></div>
				                </div>
				                <div class="form-group">
					                <label for="rvdsfPrinterIPAddressSalesRegisterInput">@Html.LocalizeString("PrinterIPAddressLabel")</label>
					                <input type="text" class="form-control input-lg" id="rvdsfPrinterIPAddressSalesRegisterInput" placeholder="192.168.0.100" data-bind="value: PrinterIPAddress" onclick="this.select()">
				                </div>
                                <div class="form-group">
					                <label for="rvdsfPrinterPortSalesRegisterInput">@Html.LocalizeString("PrinterPortLabel")</label>
					                <input type="number" class="form-control input-lg" min="1" id="rvdsfPrinterPortSalesRegisterInput" placeholder="8043" data-bind="value: PrinterPort" onclick="this.select()">
				                </div>
                                <div class="form-group">
					                <label for="rvdsfPrinterCopiesSalesRegisterInput">@Html.LocalizeString("PrinterCopiesLabel")</label>
					                <input type="number" class="form-control input-lg" min="0" id="rvdsfPrinterCopiesSalesRegisterInput" placeholder="1" data-bind="value: PrinterCopies" onclick="this.select()">
				                </div>
                                <div class="form-group">
                                            <label>@Html.LocalizeString("UsernameLabel")</label>
                                            <input type="number" class="form-control input-lg" id="rvdsfDefaultCustomerUserIDSalesRegisterInput" data-bind="value: DefaultCustomer.Username"/>
                                            <script>
                                                $(document).ready(function () {
                                                    $('#rvdsfDefaultCustomerUserIDSalesRegisterInput').kendoComboBox({
                                                        dataTextField: "Username",
                                                        dataValueField: "UserID",
                                                        filter: "contains",
                                                        autoBind: false,
                                                        minLength: 2,
                                                        clearButton: true,
                                                        placeholder: '@Html.LocalizeString("UsernamePlaceholder")',
                                                        template: '<span class="k-state-default" style="background-image: url(\'#: data.Profile.PhotoURL #\')"></span>' +
                                                                    '<span class="k-state-default"><strong>#: data.DisplayName #</strong><p>#: data.Email #</p></span>',
                                                        change: function (e) {
                                                            if (this.dataItem()) {
                                                                salesRegisterContainer.viewModel.DefaultCustomer.UserID(this.dataItem().UserID)
                                                            }
                                                            else {
                                                                salesRegisterContainer.viewModel.DefaultCustomer.UserID(null)
                                                            }
                                                        },
                                                        dataSource: new kendo.data.DataSource({
									                        serverFiltering: true,
									                        serverPaging: true,
									                        pageSize: 50,
									                        transport: {
										                        read: {
											                        type: 'POST',
											                        url: function () { return servicesFramework.getServiceRoot('Revindex.Dnn.RevindexStorefront') + 'User/Lookup' },
											                        beforeSend: servicesFramework.setModuleHeaders,
											                        dataType: 'json',
											                        contentType: 'application/json; charset=UTF-8'
										                        },
                                                                parameterMap: function (data, type) {
											                        return kendo.stringify({
												                        Query: data.filter && data.filter.filters.length > 0 ? data.filter.filters[0].value : '',
												                        ItemIndex: 0,
												                        MaxItems: data.pageSize
											                        })
										                        }
									                        },
									                        sort: [{ field: 'DisplayName', dir: 'asc' }]
								                        })
                                                    })
                                                })
                                            </script>
                                        </div>
			                </div>
			                <div class="modal-footer">
                                <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: cancelSettings">@Html.LocalizeString("CancelLink")</button>
				                <button type="button" class="btn btn-primary btn-lg" data-bind="click: saveSettings">@Html.LocalizeString("SaveLink")</button>
			                </div>
		                </div>
	                </div>
                </div>

                <div id="rvdsfShippingSalesRegisterModal" class="modal fade" tabindex="-1" role="dialog">
	                <div class="modal-dialog modal-lg" role="document">
		                <div class="modal-content" id="rvdsfShippingSalesRegisterContainer">
			                <div class="modal-header">
				                <h4 class="modal-title">@Html.LocalizeString("ShippingHeader")</h4>
			                </div>
			                <div class="modal-body">
                                <div class="row">
                                    <div class="col-sm-6">
						                <div class="form-group">
							                <label for="rvdsfShippingNameSalesRegisterInput">@Html.LocalizeString("ShippingFirstNameLabel")</label>
							                <input type="text" class="form-control input-lg" id="rvdsfShippingFirstNameSalesRegisterInput" data-bind="value: SalesOrderSet.ShippingFirstName">
						                </div>
                                        <div class="form-group">
							                <label for="rvdsfShippingNameSalesRegisterInput">@Html.LocalizeString("ShippingLastNameLabel")</label>
							                <input type="text" class="form-control input-lg" id="rvdsfShippingLastNameSalesRegisterInput" data-bind="value: SalesOrderSet.ShippingLastName">
						                </div>
                                        <div class="form-group">
						                    <label>@Html.LocalizeString("ShippingCompanyLabel")</label>
						                    <input name="rvdsfShippingCompanySalesRegisterInput" type="text" maxlength="100" class="form-control input-lg" data-bind="value: SalesOrderSet.ShippingCompany" />
					                    </div>
						                <div class="form-group">
							                <label for="rvdsfShippingEmailSalesRegisterInput">@Html.LocalizeString("ShippingEmailLabel")</label>
							                <input type="email" class="form-control input-lg" id="rvdsfShippingEmailSalesRegisterInput" data-bind="value: SalesOrderSet.ShippingEmail">
						                </div>
						                <div class="form-group">
							                <label for="rvdsfShippingPhoneSalesRegisterInput">@Html.LocalizeString("ShippingPhoneLabel")</label>
							                <input type="tel" class="form-control input-lg" id="rvdsfShippingPhoneSalesRegisterInput" data-bind="value: SalesOrderSet.ShippingPhone">
						                </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="form-group">
						                    <label class="required">@Html.LocalizeString("ShippingCountryLabel")</label>
						                    <select class="form-control input-lg" required data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" data-bind="options: ShippingCountries, optionsText: 'Name', optionsValue: 'IsoAlpha2Code', value: SalesOrderSet.ShippingCountryCode, event: { blur: shippingCountryChanged }" ></select>
					                    </div>
					                    <div class="form-group">
						                    <label>@Html.LocalizeString("ShippingStreetLabel")</label>
						                    <input type="text" name="rvdsfShippingStreetSalesRegisterInput" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" maxlength="200" class="form-control input-lg" data-bind="value: SalesOrderSet.ShippingStreet" placeholder="@Html.LocalizeString("StreetPlaceHolder")" />
					                    </div>
					                    <div class="form-group">
                                            <label></label>
						                    <input type="text" name="rvdsfShippingUnitSalesRegisterInput" maxlength="200" class="form-control input-lg" data-bind="value: SalesOrderSet.ShippingUnit" placeholder="@Html.LocalizeString("UnitPlaceHolder")" />
					                    </div>
					                    <div class="form-group" data-bind="visible: ShippingDistrictRequired()" >
						                    <label>@Html.LocalizeString("ShippingDistrictLabel")</label>
						                    <input type="text" name="rvdsfShippingDistrictSalesRegisterInput" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" maxlength="50" class="form-control input-lg" data-bind="value: SalesOrderSet.ShippingDistrict" />
					                    </div>
					                    <div class="form-group">
						                    <label>@Html.LocalizeString("ShippingCityLabel")</label>
						                    <input name="rvdsfShippingCitySalesRegisterInput" type="text" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" maxlength="50" class="form-control input-lg" data-bind="value: SalesOrderSet.ShippingCity" />
					                    </div>
                                        <!-- ko if: ShippingSubdivisions().length > 1 -->
					                    <div class="form-group">
						                    <label class="required">@Html.LocalizeString("ShippingSubdivisionLabel")</label>
						                    <select class="form-control input-lg" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" data-bind="options: ShippingSubdivisions, optionsText: 'Name', optionsValue: 'IsoCode', value: SalesOrderSet.ShippingSubdivisionCode, valueAllowUnset: true, event: { blur: getAvailableShippingMethods }" required ></select>
					                    </div>
                                        <!-- /ko -->
					                    <div class="form-group">
						                    <label>@Html.LocalizeString("ShippingPostalCodeLabel")</label>
						                    <input name="rvdsfShippingPostalCodeSalesRegisterInput" type="text" data-msg="@Html.LocalizeString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile)" maxlength="10" class="form-control input-lg" data-bind="value: SalesOrderSet.ShippingPostalCode, event: { change: getAvailableShippingMethods }" />
					                    </div>
                                    </div>
                                </div>
			                </div>
			                <div class="modal-footer">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: copyProfileToShipping">@Html.LocalizeString("CopyProfileLink")</button>
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: copyBilling">@Html.LocalizeString("CopyBillingLink")</button>
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-default btn-light btn-lg" data-bind="click: cancelShipping">@Html.LocalizeString("CancelLink")</button>
                                        <button type="button" class="btn btn-primary btn-lg" data-bind="disable: SalesOrderSet.SalesOrder() && SalesOrderSet.SalesOrder().Status() != 7, click: saveShipping">@Html.LocalizeString("SaveLink")</button>
                                    </div>
                                </div>
			                </div>
		                </div>
	                </div>
                </div>

            </div>
        </div>
    </div>
</div>
<div id="rvdsfLoading" class="rvd-loading" style="display: none"><img src="~/Images/Loading.gif" /></div>

@* Uses KnockoutJS. See http://knockoutjs.com *@
@{
	DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(DotNetNuke.Framework.JavaScriptLibraries.CommonJs.Knockout);
	DotNetNuke.Framework.JavaScriptLibraries.JavaScript.RequestRegistration(DotNetNuke.Framework.JavaScriptLibraries.CommonJs.KnockoutMapping);
}

@* Uses Revindex *@
<script type="text/javascript" src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/Revindex/Global.js"></script>

@* Uses ePos *@
<script type="text/javascript" src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/epos/epos.js"></script>

@* Uses jQuery Validation. See https://jqueryvalidation.org *@
<script src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/jquery-validation/jquery.validate.min.js" defer></script>
<script src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/jquery-validation/additional-methods.min.js" defer></script>

@* Uses JSON-cycle to resolve references *@
<script src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/json-cycle/cycle.js" defer></script>

@* Uses Moment library. See https://momentjs.com/ *@
<script src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/moment/min/moment-with-locales.min.js" defer></script>
<script src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/moment-timezone/moment-timezone-with-data.min.js" defer></script>

@* Uses html2canvas for print *@
<script src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/html2canvas/html2canvas.js" defer></script>

@* Uses summernote for basic html editor. See https://summernote.org/ *@
<link href="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/summernote/summernote.min.css" rel="stylesheet">
<script src="~/DesktopModules/Revindex.Dnn.RevindexStorefront/Scripts/summernote/summernote.min.js" defer></script>

<script>
    var salesRegisterContainer;
    var settingsSalesRegisterContainer;

    $(document).ready(function () {

        // Initialize progress loading
        $(document).ajaxStart(function () {
            // Only show loading if it exceeds 1 sec
            $("#rvdsfLoading").data("timer", setTimeout(function () { $("#rvdsfLoading").show(); }, 1000))
        }).ajaxStop(function () {
            if ($("#rvdsfLoading").data("timer"))
                clearTimeout($("#rvdsfLoading").data("timer"))

            $("#rvdsfLoading").hide();
        })

        // Initialize jQuery Validation with Bootstrap default styles
        $('#Form').validate({
            highlight: function(element) {
				$(element).closest('.form-group').addClass('has-error');
				$(element).addClass('is-invalid');
			},
			unhighlight: function(element) {
				$(element).closest('.form-group').removeClass('has-error');
				$(element).removeClass('is-invalid');
			},
			errorElement: 'div',
			errorClass: 'help-block invalid-feedback',
			errorPlacement: function(error, element) {
				if (element.parent('.input-group').length) {
					error.insertAfter(element.parent());
				} else if(element.prop('type') === 'checkbox') {
					error.appendTo(element.parent().parent());
				} else if(element.prop('type') === 'radio') {
					error.appendTo(element.parent().parent());
				} else {
					error.insertAfter(element);
				}
			},
			onsubmit: false
        })

        // Add custom method to validate at least one checkbox in group is selected
        $.validator.addMethod("requiredGroup", function (value, element, params) {
            if (params)
                return ($("input[name='" + params + "']:checked").length > 0)
            else
                return true
        }, "@HttpUtility.JavaScriptStringEncode(DotNetNuke.Services.Localization.Localization.GetString(Global.LocalizedStrings.Message_FieldRequiredError, Global.FilePaths.LocalSharedResourceFile))")

        // Bind KnockoutJS view model
        salesRegisterContainer = document.getElementById("rvdsfSalesRegisterContainer")
        salesRegisterContainer.databind = function (salesOrderNumber) {
            var servicesFramework = $.ServicesFramework(@Dnn.Module.ModuleID);

            $.ajax({
                context: this,
                beforeSend: servicesFramework.setModuleHeaders,
                url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/ViewModel?" + (salesOrderNumber ? "salesOrderNumber=" + salesOrderNumber : '')
            })
            .done(function (data, status) {
                var that = this
                var mapping = {
                    // Always treat SalesOrder as observable even when not null
					"SalesOrder": {
						create: function (options) {
							return options.data != null ? ko.observable(ko.mapping.fromJS(options.data)) : ko.observable();
						}
					},
                    'SalesOrders': {
                        key: function (data) {
                            return ko.utils.unwrapObservable(data.SalesOrderID);
                        }
                    }
                }

                if (this.viewModel) {
                    ko.mapping.fromJS(data, mapping, this.viewModel)

                    if (!Revindex.IsNullOrEmpty(this.viewModel.SalesOrderSet.SalesOrder().User)) {
                        this.viewModel.SalesOrderSet.Customer.UserID(Revindex.GetValue(this.viewModel.SalesOrderSet.SalesOrder().UserID))
                        this.viewModel.SalesOrderSet.Customer.Username(Revindex.GetValue(this.viewModel.SalesOrderSet.SalesOrder().User).Username())
                        this.viewModel.SalesOrderSet.Customer.FirstName(Revindex.GetValue(this.viewModel.SalesOrderSet.SalesOrder().User).FirstName())
                        this.viewModel.SalesOrderSet.Customer.LastName(Revindex.GetValue(this.viewModel.SalesOrderSet.SalesOrder().User).LastName())
                        this.viewModel.SalesOrderSet.Customer.Email(Revindex.GetValue(this.viewModel.SalesOrderSet.SalesOrder().User).Email())
                        this.viewModel.SalesOrderSet.Customer.Phone(Revindex.GetValue(this.viewModel.SalesOrderSet.SalesOrder().User).Profile.Telephone())
                    }
                    else {
                        this.viewModel.SalesOrderSet.Customer.UserID(null)
                        this.viewModel.SalesOrderSet.Customer.Username(null)
                        this.viewModel.SalesOrderSet.Customer.FirstName(null)
                        this.viewModel.SalesOrderSet.Customer.LastName(null)
                        this.viewModel.SalesOrderSet.Customer.Email(null)
                        this.viewModel.SalesOrderSet.Customer.Phone(null)
                    }

                    // Select the user combobox
                    userIDComboBox = $('#rvdsfUserIDSalesRegisterInput').data('kendoComboBox')
                    userIDComboBox.value(null)
                    userIDComboBox.dataSource.data([])
                    if (this.viewModel.SalesOrderSet.Customer.UserID()) {
                        userIDComboBox.dataSource.add(data.SalesOrderSet.SalesOrder.User)
                        userIDComboBox.select(0)
                    }

                    // We need to trigger country changed so that subdivision dropdown can be updated
                    this.viewModel.billingCountryChanged()
                    this.viewModel.shippingCountryChanged()

                    that.viewModel.SalesOrderSet.CouponCodeList.removeAll()
                    if (this.viewModel.SalesOrderSet.CouponCodes())
                        this.viewModel.SalesOrderSet.CouponCodes().split('|').map(function (c) {
                            c = c.trim()
                            if (c)
                                that.viewModel.SalesOrderSet.CouponCodeList.push(c)
                        })

                    // Update HTML editor
                    $('#rvdsfAdminNotesSalesRegisterContainer').summernote({
                        height: '30vh',
                        toolbar: [
                            ['style', ['bold', 'italic', 'underline', 'clear']],
                            ['color', ['color']],
                            ['para', ['ul', 'ol']],
                            ['insert', ['link']],
                        ]
                    });
                    $('#rvdsfAdminNotesSalesRegisterContainer').summernote('code', this.viewModel.SalesOrderSet.AdminNotes());
                }
                else {
                    this.viewModel = ko.mapping.fromJS(data, mapping);

                    this.viewModel.CategoryOptions = ko.observableArray(null)
                    this.viewModel.CouponError = ko.observable(null)
                    this.viewModel.CustomerError = ko.observable(null)
                    this.viewModel.DefaultCustomer = {}
                    this.viewModel.DefaultCustomer.UserID = ko.observable(null)
                    this.viewModel.DefaultCustomer.Username = ko.observable(null)
                    this.viewModel.PrinterConnected = ko.observable(false)
                    this.viewModel.Products = ko.observableArray(null)
                    this.viewModel.SalesOrderDetailError = ko.observable(null)
                    this.viewModel.SalesOrderDetail = ko.observable(null)
                    this.viewModel.SalesOrderDetailQuantity = ko.observable(0)
                    this.viewModel.SalesPaymentError = ko.observable(null)
                    this.viewModel.PaymentAmount = ko.observable(0.00)
                    this.viewModel.VoucherCode = ko.observable(null)

                    this.viewModel.PrinterCopies = ko.observable(null)
                    this.viewModel.PrinterIPAddress = ko.observable(null)
                    this.viewModel.PrinterPort = ko.observable(null)
                    this.viewModel.SalesRegisterKey = ko.observable(null)

                    this.viewModel.SalesOrderSet.Customer = {}
                    this.viewModel.SalesOrderSet.Customer.UserID = ko.observable(null)
                    this.viewModel.SalesOrderSet.Customer.Username = ko.observable(null)
                    this.viewModel.SalesOrderSet.Customer.FirstName = ko.observable(null)
                    this.viewModel.SalesOrderSet.Customer.LastName = ko.observable(null)
                    this.viewModel.SalesOrderSet.Customer.Email = ko.observable(null)
                    this.viewModel.SalesOrderSet.Customer.Phone = ko.observable(null)

                    if (!this.viewModel.SalesOrderSet.BillingCity())
						this.viewModel.SalesOrderSet.BillingCity(this.viewModel.DefaultBillingCity())

					if (!this.viewModel.SalesOrderSet.BillingCompany())
						this.viewModel.SalesOrderSet.BillingCompany(this.viewModel.DefaultBillingCompany())

					if (!this.viewModel.SalesOrderSet.BillingCountryCode())
						this.viewModel.SalesOrderSet.BillingCountryCode(this.viewModel.DefaultBillingCountryCode())

                    this.viewModel.BillingCountries = ko.observableArray()
                    this.viewModel.BillingSubdivisions = ko.observableArray()

					if (!this.viewModel.SalesOrderSet.BillingEmail())
						this.viewModel.SalesOrderSet.BillingEmail(this.viewModel.DefaultBillingEmail())

					if (!this.viewModel.SalesOrderSet.BillingFirstName())
						this.viewModel.SalesOrderSet.BillingFirstName(this.viewModel.DefaultBillingFirstName())

					if (!this.viewModel.SalesOrderSet.BillingLastName())
						this.viewModel.SalesOrderSet.BillingLastName(this.viewModel.DefaultBillingLastName())

					if (!this.viewModel.SalesOrderSet.BillingPhone())
						this.viewModel.SalesOrderSet.BillingPhone(this.viewModel.DefaultBillingPhone())

					if (!this.viewModel.SalesOrderSet.BillingPostalCode())
						this.viewModel.SalesOrderSet.BillingPostalCode(this.viewModel.DefaultBillingPostalCode())

					this.viewModel.BillingDistrictRequired = ko.observable(false)
                    this.viewModel.BillingPostalCodeRequired = ko.observable(true)

					if (!this.viewModel.SalesOrderSet.BillingStreet())
						this.viewModel.SalesOrderSet.BillingStreet(this.viewModel.DefaultBillingStreet())

					if (!this.viewModel.SalesOrderSet.BillingUnit())
						this.viewModel.SalesOrderSet.BillingUnit(this.viewModel.DefaultBillingUnit())

					if (!this.viewModel.SalesOrderSet.BillingDistrict())
						this.viewModel.SalesOrderSet.BillingDistrict(this.viewModel.DefaultBillingDistrict())

					if (!this.viewModel.SalesOrderSet.BillingSubdivisionCode())
						this.viewModel.SalesOrderSet.BillingSubdivisionCode(this.viewModel.DefaultBillingSubdivisionCode())

					if (!this.viewModel.SalesOrderSet.BusinessTaxNumber())
						this.viewModel.SalesOrderSet.BusinessTaxNumber(this.viewModel.DefaultBusinessTaxNumber())

                    this.viewModel.SalesOrderSet.CouponCodeList = ko.observableArray()
                    if (this.viewModel.SalesOrderSet.CouponCodes())
                        this.viewModel.SalesOrderSet.CouponCodes().split('|').map(function (c) {
                            that.viewModel.SalesOrderSet.CouponCodeList.push(c)
                        })

                    this.viewModel.SelectedCategory = ko.observable(null)
                    this.viewModel.SelectedProductVariant = ko.observable(null)

                    if (!this.viewModel.SalesOrderSet.ShippingCity())
						this.viewModel.SalesOrderSet.ShippingCity(this.viewModel.DefaultShippingCity())

					if (!this.viewModel.SalesOrderSet.ShippingCompany())
						this.viewModel.SalesOrderSet.ShippingCompany(this.viewModel.DefaultShippingCompany())

					if (!this.viewModel.SalesOrderSet.ShippingCountryCode())
						this.viewModel.SalesOrderSet.ShippingCountryCode(this.viewModel.DefaultShippingCountryCode())

                    this.viewModel.ShippingCountries = ko.observableArray()
                    this.viewModel.ShippingSubdivisions = ko.observableArray()

					if (!this.viewModel.SalesOrderSet.ShippingEmail())
						this.viewModel.SalesOrderSet.ShippingEmail(this.viewModel.DefaultShippingEmail())

					if (!this.viewModel.SalesOrderSet.ShippingFirstName())
						this.viewModel.SalesOrderSet.ShippingFirstName(this.viewModel.DefaultShippingFirstName())

					if (!this.viewModel.SalesOrderSet.ShippingLastName())
						this.viewModel.SalesOrderSet.ShippingLastName(this.viewModel.DefaultShippingLastName())

					if (!this.viewModel.SalesOrderSet.ShippingPhone())
						this.viewModel.SalesOrderSet.ShippingPhone(this.viewModel.DefaultShippingPhone())

					if (!this.viewModel.SalesOrderSet.ShippingPostalCode())
						this.viewModel.SalesOrderSet.ShippingPostalCode(this.viewModel.DefaultShippingPostalCode())

					this.viewModel.ShippingDistrictRequired = ko.observable(false)
					this.viewModel.ShippingPostalCodeRequired = ko.observable(true)

					if (!this.viewModel.SalesOrderSet.ShippingStreet())
						this.viewModel.SalesOrderSet.ShippingStreet(this.viewModel.DefaultShippingStreet())

					if (!this.viewModel.SalesOrderSet.ShippingUnit())
						this.viewModel.SalesOrderSet.ShippingUnit(this.viewModel.DefaultShippingUnit())

					if (!this.viewModel.SalesOrderSet.ShippingDistrict())
						this.viewModel.SalesOrderSet.ShippingDistrict(this.viewModel.DefaultShippingDistrict())

					if (!this.viewModel.SalesOrderSet.ShippingSubdivisionCode())
                        this.viewModel.SalesOrderSet.ShippingSubdivisionCode(this.viewModel.DefaultShippingSubdivisionCode())

                    this.viewModel.ShippingSubdivisions = ko.observableArray()

                    this.viewModel.addCoupon = function (couponCode) {
						that.viewModel.CouponError(null)

                        var couponData = {
                            CouponCode: couponCode,
                            SalesOrderID: that.viewModel.SalesOrderSet.SalesOrder().SalesOrderID()
                        }

						$.ajax({
							context: this,
							type: "POST",
							beforeSend: servicesFramework.setModuleHeaders,
							url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/Coupon",
							data: couponData
						})
						.done(function (data, textStatus, jqXHR) {
							this.SalesOrderSet.CouponCodeList.push(couponCode)

							that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
						})
						.fail(function (data, textStatus, errorThrown) {
							if ($.trim(data.responseText))
								that.viewModel.CouponError(data.responseJSON.Message)
						})
					}

                	this.viewModel.addProductToCart = function (productVariantID, quantity, messageContainerID) {
                		var salesOrderDetailData = {
                			ProductVariantID: productVariantID,
                            Quantity: quantity,
                            SalesOrderID: that.viewModel.SalesOrderSet.SalesOrder().SalesOrderID()
                		}

                		var servicesFramework = $.ServicesFramework(@Dnn.Module.ModuleID);

                		$.ajax({
                			type: "POST",
                			beforeSend: servicesFramework.setModuleHeaders,
                			url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesOrderDetail",
                			data: salesOrderDetailData
                		})
                        .done(function (data, textStatus, jqXHR) {
                            that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                            // Scroll to bottom
                            setTimeout(function () { $('#rvdsfSalesOrderDetailsSalesRegisterContainer').scrollTop($('#rvdsfSalesOrderDetailsSalesRegisterContainer')[0].scrollHeight); }, 500)
                            
                        })
                        .fail(function (data, textStatus, errorThrown) {
                        	$("#" + messageContainerID).attr("class", "alert alert-danger").html("<span class='glyphicon glyphicon-remove fa fas fa-exclamation-circle'></span> " + (data.responseJSON.Message ? kendo.htmlEncode(data.responseJSON.Message) : "@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ProductNotAvailable, Global.FilePaths.LocalSharedResourceFile))")).show().fadeOut(10000)
                        })
                    }

                    this.viewModel.billingCountryChanged = function () {

						var get = $.ajax({
							context: this,
							type: "GET",
							beforeSend: servicesFramework.setModuleHeaders,
							url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "Globalization/Subdivisions?Active=true&CountryCode=" + this.SalesOrderSet.BillingCountryCode(),
						})


						get.done(function (data, textStatus, jqXHR) {

							var country = null
							this.BillingCountries().map(function (c) {
								if (c.IsoAlpha2Code == this.SalesOrderSet.BillingCountryCode())
									country = c
							}, this)

							if (country) {
								this.BillingDistrictRequired(country.HasDistrictSystem)
								this.BillingPostalCodeRequired(country.HasPostalCodeSystem)
							}

							// Change underlying array items and fire valueHasMutated to prevent
							// calling getAvailableShippingMethods repeatedly as array is being changed
							var billingSubdivisions = this.BillingSubdivisions()
							billingSubdivisions.length = 0

							billingSubdivisions.push({ Name: '', IsoCode: '' })
							if (country.IsSubdivisionRequired) {
								$.each(data, function () {
									billingSubdivisions.push({ Name: this.Name, IsoCode: this.IsoCode })
								})
							}
							this.BillingSubdivisions.valueHasMutated()

							if (!this.SalesOrderSet.BillingSubdivisionCode() || !this.SalesOrderSet.BillingSubdivisionCode().startsWith(this.SalesOrderSet.BillingCountryCode())) {
								if (this.BillingSubdivisions().length > 0)
									this.SalesOrderSet.BillingSubdivisionCode(this.BillingSubdivisions()[0].IsoCode)
								else
									this.SalesOrderSet.BillingSubdivisionCode(null)
							}
						})

						return get
                    }

                    this.viewModel.cancelCustomer = function () {
                        that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
                        $('#rvdsfCustomerSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.cancelBilling = function () {
                        that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
                        $('#rvdsfBillingSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.cancelNotes = function () {
                        that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
                        $('#rvdsfNotesSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.cancelSalesPayments = function () {
                        that.viewModel.SalesPaymentError(null)
                        that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
                        $('#rvdsfSalesPaymentsSalesRegisterModal').modal('hide')
                    }

                    // TODO:
                    this.viewModel.cancelSettings = function () {
                        $('#rvdsfSettingsSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.cancelShipping = function () {
                        that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
                        $('#rvdsfShippingSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.formattedChangeDue = ko.computed(function () {
                        if (this.SalesOrderSet && this.SalesOrderSet.SalesOrder)
                            return this.formatCurrency(this.PaymentAmount() + this.SalesOrderSet.BalanceDue())
                        else
                            return null
                    }, this)

                    this.viewModel.copyBilling = function () {

                        that.viewModel.SalesOrderSet.ShippingFirstName(that.viewModel.SalesOrderSet.BillingFirstName())
                        that.viewModel.SalesOrderSet.ShippingLastName(that.viewModel.SalesOrderSet.BillingLastName())
                        that.viewModel.SalesOrderSet.ShippingCompany(that.viewModel.SalesOrderSet.BillingCompany())
                        that.viewModel.SalesOrderSet.ShippingEmail(that.viewModel.SalesOrderSet.BillingEmail())
                        that.viewModel.SalesOrderSet.ShippingPhone(that.viewModel.SalesOrderSet.BillingPhone())

                        that.viewModel.SalesOrderSet.ShippingCountryCode(that.viewModel.SalesOrderSet.BillingCountryCode())
                        that.viewModel.shippingCountryChanged()

                        that.viewModel.SalesOrderSet.ShippingStreet(that.viewModel.SalesOrderSet.BillingStreet())
                        that.viewModel.SalesOrderSet.ShippingUnit(that.viewModel.SalesOrderSet.BillingUnit())
                        that.viewModel.SalesOrderSet.ShippingDistrict(that.viewModel.SalesOrderSet.BillingDistrict())
                        that.viewModel.SalesOrderSet.ShippingCity(that.viewModel.SalesOrderSet.BillingCity())
                        that.viewModel.SalesOrderSet.ShippingSubdivisionCode(that.viewModel.SalesOrderSet.BillingSubdivisionCode())
                        that.viewModel.SalesOrderSet.ShippingPostalCode(that.viewModel.SalesOrderSet.BillingPostalCode())
                    }

                    this.viewModel.copyEmail = function () {

                        that.viewModel.SalesOrderSet.Customer.Email($('#rvdsfUserIDSalesRegisterInput').data("kendoComboBox").text())
                    }

                    this.viewModel.copyFirstName = function () {

                        that.viewModel.SalesOrderSet.Customer.FirstName($('#rvdsfUserIDSalesRegisterInput').data("kendoComboBox").text())
                    }

                    this.viewModel.copyLastName = function () {

                        that.viewModel.SalesOrderSet.Customer.LastName($('#rvdsfUserIDSalesRegisterInput').data("kendoComboBox").text())
                    }

                    this.viewModel.copyProfileToBilling = function () {

                        if (that.viewModel.SalesOrderSet.Customer.UserID()) {
                            that.viewModel.SalesOrderSet.BillingFirstName(that.viewModel.SalesOrderSet.Customer.FirstName())
                            that.viewModel.SalesOrderSet.BillingLastName(that.viewModel.SalesOrderSet.Customer.LastName())
                            that.viewModel.SalesOrderSet.BillingEmail(that.viewModel.SalesOrderSet.Customer.Email())
                            that.viewModel.SalesOrderSet.BillingPhone(that.viewModel.SalesOrderSet.Customer.Profile.Telephone())
                        }
                    }

                    this.viewModel.copyProfileToShipping = function () {

                        if (that.viewModel.SalesOrderSet.Customer.UserID()) {
                            that.viewModel.SalesOrderSet.ShippingFirstName(that.viewModel.SalesOrderSet.Customer.FirstName())
                            that.viewModel.SalesOrderSet.ShippingLastName(that.viewModel.SalesOrderSet.Customer.LastName())
                            that.viewModel.SalesOrderSet.ShippingEmail(that.viewModel.SalesOrderSet.Customer.Email())
                            that.viewModel.SalesOrderSet.ShippingPhone(that.viewModel.SalesOrderSet.Customer.Profile.Telephone())
                        }
                    }

                    this.viewModel.copyShipping = function () {

                        that.viewModel.SalesOrderSet.BillingFirstName(that.viewModel.SalesOrderSet.ShippingFirstName())
                        that.viewModel.SalesOrderSet.BillingLastName(that.viewModel.SalesOrderSet.ShippingLastName())
                        that.viewModel.SalesOrderSet.BillingCompany(that.viewModel.SalesOrderSet.ShippingCompany())
                        that.viewModel.SalesOrderSet.BillingEmail(that.viewModel.SalesOrderSet.ShippingEmail())
                        that.viewModel.SalesOrderSet.BillingPhone(that.viewModel.SalesOrderSet.ShippingPhone())

                        that.viewModel.SalesOrderSet.BillingCountryCode(that.viewModel.SalesOrderSet.ShippingCountryCode())
                        that.viewModel.billingCountryChanged()

                        that.viewModel.SalesOrderSet.BillingStreet(that.viewModel.SalesOrderSet.ShippingStreet())
                        that.viewModel.SalesOrderSet.BillingUnit(that.viewModel.SalesOrderSet.ShippingUnit())
                        that.viewModel.SalesOrderSet.BillingDistrict(that.viewModel.SalesOrderSet.ShippingDistrict())
                        that.viewModel.SalesOrderSet.BillingCity(that.viewModel.SalesOrderSet.ShippingCity())
                        that.viewModel.SalesOrderSet.BillingSubdivisionCode(that.viewModel.SalesOrderSet.ShippingSubdivisionCode())
                        that.viewModel.SalesOrderSet.BillingPostalCode(that.viewModel.SalesOrderSet.ShippingPostalCode())
                    }

                    this.viewModel.createSalesOrder = function () {

                        $.ajax({
                            type: "POST",
                            beforeSend: servicesFramework.setModuleHeaders,
                            url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesOrder"
                        })
                        .done(function (data, textStatus, jqXHR) {
                            that.databind(data.SalesOrderNumber)
                        })
                        .fail(function (data, textStatus, errorThrown) {
                            Revindex.Dnn.RevindexStorefront.ShowMessage("#rvdsfSalesRegisterMessage", "alert alert-danger rvd-alert-important", data.responseJSON.Message ? kendo.htmlEncode(data.responseJSON.Message) : "@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ActionFailed, Global.FilePaths.LocalSharedResourceFile))")
                        })
                    }

                    this.viewModel.emailReceipt = function () {
						var salesOrderData = {
							SalesOrderGUID: that.viewModel.SalesOrderGUID()
                        }

                        $.ajax({
                            type: "PUT",
                            beforeSend: servicesFramework.setModuleHeaders,
                            url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/Email",
							data: salesOrderData
                        })
                        .done(function (data, textStatus, jqXHR) {
                            Revindex.Dnn.RevindexStorefront.ShowMessage("#rvdsfSalesRegisterMessage", "alert alert-success rvd-alert-important", "@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ActionSuccess, Global.FilePaths.LocalSharedResourceFile))")
                        })
                        .fail(function (data, textStatus, errorThrown) {
                            Revindex.Dnn.RevindexStorefront.ShowMessage("#rvdsfSalesRegisterMessage", "alert alert-danger rvd-alert-important", data.responseJSON.Message ? kendo.htmlEncode(data.responseJSON.Message) : "@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ActionFailed, Global.FilePaths.LocalSharedResourceFile))")
                        })
                    }

                    this.viewModel.getAvailableShippingMethods = function () {
                        // TODO:
						@*this.GeneralError(null)
						this.AvailableShippingMethodsRequested(true)

						if (this.SameAsBilling()) {
							this.SalesOrderSet.ShippingFirstName(this.SalesOrderSet.BillingFirstName())
							this.SalesOrderSet.ShippingLastName(this.SalesOrderSet.BillingLastName())
							this.SalesOrderSet.ShippingCompany(this.SalesOrderSet.BillingCompany())
							this.SalesOrderSet.ShippingStreet(this.SalesOrderSet.BillingStreet())
							this.SalesOrderSet.ShippingUnit(this.SalesOrderSet.BillingUnit())
							this.SalesOrderSet.ShippingDistrict(this.SalesOrderSet.BillingDistrict())
							this.SalesOrderSet.ShippingCity(this.SalesOrderSet.BillingCity())
							this.SalesOrderSet.ShippingCountryCode(this.SalesOrderSet.BillingCountryCode())
							this.SalesOrderSet.ShippingSubdivisionCode(this.SalesOrderSet.BillingSubdivisionCode())
							this.SalesOrderSet.ShippingPostalCode(this.SalesOrderSet.BillingPostalCode())
							this.SalesOrderSet.ShippingPhone(this.SalesOrderSet.BillingPhone())
							this.SalesOrderSet.ShippingEmail(this.SalesOrderSet.BillingEmail())
						}

						this.GeneralError(null)

						var that = this
						var promise = this.updateSalesOrderSet('BillingInformation|ShippingInformation')
						promise.done(function () {

							// Estimate shipping for each order
							that.SalesOrderSet.SalesOrders().map(function (so) {

								// Re-add client side observables in case new product was added to cart
								// that belongs to a new sales order but page wasn't refreshed
								if (typeof so.AvailableShippingMethods !== "function")
									so.AvailableShippingMethods = ko.observableArray()

								if (typeof so.AvailableShippingMethodsError !== "function")
									so.AvailableShippingMethodsError = ko.observable(null)

								so.AvailableShippingMethodsError(null)
								so.AvailableShippingMethods.removeAll()

								// Only handle cases where the subdivision is valid. The subdivision may be invalid as a side effect when the country is changed and the list
								// of subdivisions are reloaded.
								if (typeof that.SalesOrderSet.ShippingSubdivisionCode() != "undefined" && (that.SalesOrderSet.ShippingSubdivisionCode() == "" || that.SalesOrderSet.ShippingSubdivisionCode().startsWith(that.SalesOrderSet.ShippingCountryCode()))) {

									$.ajax({
										context: that,
										type: "GET",
										beforeSend: servicesFramework.setModuleHeaders,
										url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "Cart/ShippingEstimationViewModel?SalesOrderID=" + so.SalesOrderID() + "&ShippingCity=" + escape(that.SalesOrderSet.ShippingCity()) + "&ShippingCountryCode=" + that.SalesOrderSet.ShippingCountryCode() + "&ShippingPostalCode=" + escape(that.SalesOrderSet.ShippingPostalCode()) + "&ShippingSubdivisionCode=" + that.SalesOrderSet.ShippingSubdivisionCode() + "&ShippingStreet=" + escape(that.SalesOrderSet.ShippingStreet()) + "&ShippingUnit=" + escape(that.SalesOrderSet.ShippingUnit()) + "&ShippingDistrict=" + escape(that.SalesOrderSet.ShippingDistrict())
									})
									.done(function (data, textStatus, jqXHR) {

										if (so.RequireShipping() && data.ShippingMethods.length == 0)
											so.AvailableShippingMethodsError("@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ShippingMethodsUndefined, Global.FilePaths.LocalSharedResourceFile))")

										so.AvailableShippingMethods.removeAll()
										data.ShippingMethods.map(function (sm) {

											so.AvailableShippingMethods.push(ko.observable(sm))
										})

										// Select first available shipping method if none is selected, or if previous selection is invalid
										var previousShippingMethodID = so.ShippingMethodID()
										if (so.AvailableShippingMethods().length > 0) {
											if (so.ShippingMethodID() == null || !so.AvailableShippingMethods().some(function (sm) { return sm().ShippingMethodID == so.ShippingMethodID(); })) {
												so.ShippingMethodID(so.AvailableShippingMethods()[0]().ShippingMethodID)
												so.ShippingDestinationPoint(null)
												so.ShippingExtension(null)
											}
										}
										else {
											so.ShippingMethodID(null)
											so.ShippingDestinationPoint(null)
											so.ShippingExtension(null)
										}

										// Update server if selected shipping method changed
										if (so.ShippingMethodID() != previousShippingMethodID)
											that.updateSalesOrderShippingMethod(so.SalesOrderID(), so.ShippingMethodID(), so.ShippingDestinationPoint(), so.ShippingExtension())
									})
									.fail(function (data, textStatus, errorThrown) {
										if ($.trim(data.responseText))
											so.AvailableShippingMethodsError(data.responseJSON.Message)
									})
								}
							})
						})
						.fail(function (data, textStatus, errorThrown) {
							if (data.status == 403)
								window.location.replace(that.Cart.TabUrl())
							else if ($.trim(data.responseText))
								that.GeneralError(data.responseJSON.Message)

							$(window).scrollTop($("#rvdsfCheckoutPanelContainer").offset().top)
						})*@
					}

                    this.viewModel.getSalesRegisterPrinterCopies = function () {
                        var copies = localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterPrinterCopies + "|" + Dnn.Portal.PortalId)')
                        if (!copies)
                            copies = 1

                        return copies
                    }

                    this.viewModel.getSalesRegisterPrinterIPAddress = function () {
                        return localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterPrinterIPAddress + "|" + Dnn.Portal.PortalId)')
                    }

                    this.viewModel.getSalesRegisterPrinterPort = function () {
                        var port = localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterPrinterPort + "|" + Dnn.Portal.PortalId)')
                        if (!port)
                            port = 8043

                        return port
                    }

                    this.viewModel.getSalesRegisterDefaultCustomer = function () {
                        return localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterDefaultCustomer + "|" + Dnn.Portal.PortalId)')
                    }

                    this.viewModel.getSalesRegisterKey = function () {
                        // Generate new random key if not found
                        if (!dnn.dom.getCookie('@(Global.CookieKeys.SalesRegisterKey + "|" + Dnn.Portal.PortalId)'))
                            dnn.dom.setCookie('@(Global.CookieKeys.SalesRegisterKey + "|" + Dnn.Portal.PortalId)', Math.floor(100000 + Math.random() * 900000), 100000000, '/')

                        return dnn.dom.getCookie('@(Global.CookieKeys.SalesRegisterKey + "|" + Dnn.Portal.PortalId)')
                    }

                    this.viewModel.getSalesRegisterSalesPayments = function () {
                        var jSalesPayments = localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterSalesPayments + "|" + Dnn.Portal.PortalId)')
                        if (jSalesPayments)
                            return JSON.parse(jSalesPayments)
                        
                        return new Array()
                    }

                    this.viewModel.getSalesRegisterStartCash = function () {
                        var startCash = localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterStartCash + "|" + Dnn.Portal.PortalId)')

                        if (startCash)
                            return parseFloat(startCash)
                        else
                            return 0
                    }

                    this.viewModel.getSalesRegisterStartDate = function () {                    
                        return localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterStartDate + "|" + Dnn.Portal.PortalId)')
                    }

                    this.viewModel.getSalesRegisterStopCash = function () {
                        var startCash = that.viewModel.getSalesRegisterStartCash()
                        var cashFlow = 0

                        var salesPayments = that.viewModel.getSalesRegisterSalesPayments()
                        if (salesPayments) {
                            salesPayments.map(function (sp) {
                                if (sp.PaymentMethod == 1)
                                    cashFlow += sp.Amount
                            })
                        }

                        return startCash + cashFlow
                    }

                    this.viewModel.getSalesRegisterOperatorUserID = function () {
                        return localStorage.getItem('@(Global.LocalStorageKeys.SalesRegisterOperatorUserID + "|" + Dnn.Portal.PortalId)')
                    }

                    this.viewModel.hideSalesOrders = function () {
                        $('#rvdsfSalesOrdersSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.initializeCategoryOptions = function (parentCategoryID, level) {
                        var categories = that.viewModel.Categories().filter(c => c.ParentCategoryID() == parentCategoryID)
                        if (categories.length > 0) {
                            categories.map(c => {
                                that.viewModel.CategoryOptions.push({ Name: '..'.repeat(level) + c.Name(), CategoryID: c.CategoryID() })
                                that.viewModel.initializeCategoryOptions(c.CategoryID(), level + 1)
                            })
                        }
                    }
                    this.viewModel.CategoryOptions.removeAll()
                    this.viewModel.CategoryOptions.push({ Name: '@Html.LocalizeString("CategoryLink")', CategoryID: null})
                    this.viewModel.initializeCategoryOptions(null, 0)

                    this.viewModel.initializePrinter = function () {

                        if (that.viewModel.PrinterConnected() == false || typeof (that.viewModel.ePOSPrinter) === "undefined" || that.viewModel.ePOSPrinter == null || !that.viewModel.ePOSDevice.isConnected()) {
                            that.viewModel.PrinterConnected(false)

                            that.viewModel.ePOSDevice = new epson.ePOSDevice()

                            // See https://www.tyrios.io/knowledgebase/epson-receipt-printer-set-up-ssl-certificate-135-en.html
                            // on renewing SSL certificate.
                            // Use port 8008 for HTTP or 8043 for HTTPS.
                            that.viewModel.ePOSDevice.connect(that.viewModel.getSalesRegisterPrinterIPAddress(), that.viewModel.getSalesRegisterPrinterPort(), function (result) {

                                if (result == 'OK' || result == 'SSL_CONNECT_OK') {

                                    // On IOS, we need retry repeatedly to get printer object
                                    var retry = 50;
                                    while (retry-- > 0) {
                                        that.viewModel.ePOSDevice.createDevice('local_printer',
                                        that.viewModel.ePOSDevice.DEVICE_TYPE_PRINTER,
                                        { 'crypto': false, 'buffer': false },
                                        function (device, errorCode) {
                                            if (device != null) {
                                                that.viewModel.PrinterConnected(true)

                                                that.viewModel.ePOSPrinter = device

                                                that.viewModel.ePOSPrinter.onreceive = function (response) {
                                                    if (response.success) {
                                                        Revindex.Dnn.RevindexStorefront.ShowMessage("#rvdsfSalesRegisterMessage", "alert alert-success rvd-alert-important", "@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ActionSuccess, Global.FilePaths.LocalSharedResourceFile))")
                                                    }
                                                    else {
                                                        Revindex.Dnn.RevindexStorefront.ShowMessage("#rvdsfSalesRegisterMessage", "alert alert-danger rvd-alert-important", "<span class='glyphicon glyphicon-remove fa fas fa-exclamation-circle'></span> @HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ActionFailed, Global.FilePaths.LocalSharedResourceFile))")
                                                    }
                                                }

                                                that.viewModel.ePOSPrinter.onpoweroff = function () {
                                                    that.viewModel.PrinterConnected(false)
                                                }
                                                that.viewModel.ePOSPrinter.startMonitor()

                                                // Exit
                                                retry = 0
                                            }
                                        });
                                    }
                                }
                                else {
                                    that.viewModel.PrinterConnected(false)
                                }
                            })
                        }
                    }

                    this.viewModel.IsInUse = function () {
                        return (that.viewModel.getSalesRegisterOperatorUserID())
                    }

                    this.viewModel.IsUserAuthorized = function () {
                        return (that.viewModel.getSalesRegisterOperatorUserID() == '@Dnn.User.UserID' || @(Dnn.User.IsInRole("Administrators") || Dnn.User.IsSuperUser ? "false" : "false"))
                    }

                    this.viewModel.listProducts = function () {
                        $('#rvdsfProductSearchQueryInput').val('')
                        that.viewModel.searchProducts()
                    }

                    this.viewModel.loadSalesOrder = function (salesOrderNumber) {
                        that.databind(salesOrderNumber)
                    }

                    this.viewModel.manualAuthorize = function () {
                        that.viewModel.SalesPaymentError(null)

                        var validationResult = $('#rvdsfSalesPaymentsSalesRegisterContainer input, #rvdsfSalesPaymentsSalesRegisterContainer select, #rvdsfSalesPaymentsSalesRegisterContainer textarea').valid()

                        if (validationResult) {
                            var amount = that.viewModel.PaymentAmount()

                            // Make sure cash payment does not exceed balance
                            if (that.viewModel.PrimaryPaymentMethod() == 1 && amount > that.viewModel.SalesOrderSet.BalanceDue())
                                amount = that.viewModel.SalesOrderSet.BalanceDue()

                            if (amount > 0) {
                                var salesPaymentData = {
                                    Amount: amount,
                                    PaymentMethod: that.viewModel.PrimaryPaymentMethod(),
                                    ClientScreenHeight: window.screen.height,
                                    ClientScreenWidth: window.screen.width,
                                    ClientScreenColorDepth: window.screen.colorDepth,
                                    ClientLanguage: window.navigator.language,
                                    SalesOrderID: that.viewModel.SalesOrderSet.SalesOrder().SalesOrderID(),
                                    TransactionType: 1,
                                    VoucherCode: that.viewModel.PrimaryPaymentMethod() == 10 ? that.viewModel.VoucherCode() : ''
                                }

                                $.ajax({
                                    context: this,
                                    type: "POST",
                                    beforeSend: servicesFramework.setModuleHeaders,
                                    url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesPayment",
                                    data: salesPaymentData
                                })
                                .done(function (data, textStatus, jqXHR) {
                                    that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                    var salesPayments = that.viewModel.getSalesRegisterSalesPayments()
                                    salesPayments.push({
                                        PaymentMethod: that.viewModel.PrimaryPaymentMethod(),
                                        Amount: parseFloat(amount),
                                    })
                                    that.viewModel.setSalesRegisterSalesPayments(salesPayments)

                                    $('#rvdsfSalesPaymentsSalesRegisterModal').modal('hide')
                                })
                                .fail(function (data, textStatus, errorThrown) {
                                    if ($.trim(data.responseText))
                                        this.SalesPaymentError(data.responseJSON.Message)
                                })
                            }
                        }
                    }

                    this.viewModel.manualPurchase = function () {
                        that.viewModel.SalesPaymentError(null)

                        var validationResult = $('#rvdsfSalesPaymentsSalesRegisterContainer input, #rvdsfSalesPaymentsSalesRegisterContainer select, #rvdsfSalesPaymentsSalesRegisterContainer textarea').valid()

                        if (validationResult) {
                            var amount = that.viewModel.PaymentAmount()

                            // Make sure cash payment does not exceed balance
                            if (that.viewModel.PrimaryPaymentMethod() == 1 && amount > that.viewModel.SalesOrderSet.BalanceDue())
                                amount = that.viewModel.SalesOrderSet.BalanceDue()

                            if (amount > 0) {
                                var salesPaymentData = {
                                    Amount: amount,
                                    PaymentMethod: that.viewModel.PrimaryPaymentMethod(),
                                    ClientScreenHeight: window.screen.height,
                                    ClientScreenWidth: window.screen.width,
                                    ClientScreenColorDepth: window.screen.colorDepth,
                                    ClientLanguage: window.navigator.language,
                                    SalesOrderID: that.viewModel.SalesOrderSet.SalesOrder().SalesOrderID(),
                                    TransactionType: 2,
                                    VoucherCode: that.viewModel.PrimaryPaymentMethod() == 10 ? that.viewModel.VoucherCode() : ''
                                }

                                $.ajax({
                                    context: this,
                                    type: "POST",
                                    beforeSend: servicesFramework.setModuleHeaders,
                                    url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesPayment",
                                    data: salesPaymentData
                                })
                                .done(function (data, textStatus, jqXHR) {
                                    that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                    var salesPayments = that.viewModel.getSalesRegisterSalesPayments()
                                    salesPayments.push({
                                        PaymentMethod: that.viewModel.PrimaryPaymentMethod(),
                                        Amount: parseFloat(amount),
                                    })
                                    that.viewModel.setSalesRegisterSalesPayments(salesPayments)

                                    $('#rvdsfSalesPaymentsSalesRegisterModal').modal('hide')
                                })
                                .fail(function (data, textStatus, errorThrown) {
                                    if ($.trim(data.responseText))
                                        this.SalesPaymentError(data.responseJSON.Message)
                                })
                            }
                        }
                    }

                    this.viewModel.openDrawer = function () {
                        if (that.viewModel.ePOSPrinter != null && that.viewModel.ePOSDevice.isConnected()) {
                            that.viewModel.ePOSPrinter.addPulse(that.viewModel.ePOSPrinter.DRAWER_1, that.viewModel.ePOSPrinter.PULSE_100);
                            that.viewModel.ePOSPrinter.send();
                        }
                    }

                    this.viewModel.placeOrder = function () {
                        if (that.viewModel.SalesOrderSet.SalesOrder().Status() == 7 && that.viewModel.SalesOrderSet.BalanceDue() <= 0.02) {

                            that.viewModel.updateSalesOrderSet('PlaceOrder')
							.done(function (data, textStatus, jqXHR) {
                                that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                Revindex.Dnn.RevindexStorefront.ShowMessage("#rvdsfSalesRegisterMessage", "alert alert-success rvd-alert-important", "@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ActionSuccess, Global.FilePaths.LocalSharedResourceFile))")
							})
							.fail(function (data, textStatus, errorThrown) {
								if ($.trim(data.responseText))
                                    Revindex.Dnn.RevindexStorefront.ShowMessage("#rvdsfSalesRegisterMessage", "alert alert-danger rvd-alert-important", data.responseJSON.Message ? kendo.htmlEncode(data.responseJSON.Message) : "@HttpUtility.JavaScriptStringEncode(Html.LocalizeString(Global.LocalizedStrings.Message_ActionFailed, Global.FilePaths.LocalSharedResourceFile))")
							})
                        }
                    }

                    this.viewModel.printReceipt = function () {
                        if (that.viewModel.ePOSPrinter != null && that.viewModel.ePOSDevice.isConnected()) {

                            var iframe = document.createElement('iframe')
                            iframe.style.position = "absolute"
                            iframe.style.top = "-1000px"
                            iframe.style.opacity = 0.0
                            iframe.style.width = "100%"
                            iframe.style.height = "600px"
                            iframe.style.zIndex = 0
                            document.body.appendChild(iframe)
                            iframe.addEventListener("load", function () {
                                html2canvas(iframe.contentDocument.body, {
                                    scale: 1,
                                    windowWidth: 570,
                                    width: 570,
                                }).then(function (canvas) {
                                    for (var i = 0; i < that.viewModel.getSalesRegisterPrinterCopies(); i++)
                                        that.viewModel.ePOSPrinter.print(canvas, true, that.viewModel.ePOSPrinter.MODE_GRAY16);

                                    iframe.remove()
                                })
                            });
                            iframe.src = '/DesktopModules/Revindex.Dnn.RevindexStorefront/PrintPage.aspx?portalid=@(Dnn.Portal.PortalId)&rvdsfprntpg=2&rvdsfsoguid=' + that.viewModel.SalesOrderGUID() + '&rvdsfprntoutput=preview'
                        }
                    }

                    this.viewModel.printSummary = function () {
                        if (that.viewModel.ePOSPrinter != null && that.viewModel.ePOSDevice.isConnected()) {

                            var iframe = document.createElement('iframe')
                            iframe.style.position = "absolute"
                            iframe.style.top = "-1000px"
                            iframe.style.opacity = 0.0
                            iframe.style.width = "100%"
                            iframe.style.height = "600px"
                            iframe.style.zIndex = 0
                            document.body.appendChild(iframe)
                            iframe.addEventListener("load", function () {
                                html2canvas(iframe.contentDocument.body, {
                                    scale: 1,
                                    windowWidth: 570,
                                    width: 570,
                                }).then(function (canvas) {
                                    for (var i = 0; i < that.viewModel.getSalesRegisterPrinterCopies(); i++)
                                        that.viewModel.ePOSPrinter.print(canvas, true, that.viewModel.ePOSPrinter.MODE_GRAY16);

                                    iframe.remove()
                                })
                            });

                            iframe.srcdoc = '<html><body style="font-size: 2rem">' + $('#rvdsfSessionSalesRegisterContainer .modal-body').html() + '</body></html>'
                        }
                    }

                    this.viewModel.removeCoupon = function (couponCode) {
						this.CouponError(null)

                        var couponData = {
                            CouponCode: couponCode,
                            SalesOrderID: that.viewModel.SalesOrderSet.SalesOrder().SalesOrderID()
                        }

						$.ajax({
							context: this,
							type: "DELETE",
							beforeSend: servicesFramework.setModuleHeaders,
							url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/Coupon",
							data: couponData
						})
						.done(function (data, textStatus, jqXHR) {
							that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
						})
						.fail(function (data, textStatus, errorThrown) {
							if ($.trim(data.responseText))
								this.CouponError(data.responseJSON.Message)
						})
					}

                    this.viewModel.removeSalesOrderDetail = function (salesOrderDetailID) {

                        var salesOrderDetailData = {
                            SalesOrderDetailID: salesOrderDetailID
                        }

                        $.ajax({
                            type: "DELETE",
                            beforeSend: servicesFramework.setModuleHeaders,
                            url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesOrderDetail",
                            data: salesOrderDetailData
                        })
                        .done(function (data, textStatus, jqXHR) {
							that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
                        })
                    }

                    // TODO:
                    this.viewModel.resetCart = function () {

                        $.ajax({
                            type: "DELETE",
                            beforeSend: servicesFramework.setModuleHeaders,
                            url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "Cart/Cart"
                        })
                        .done(function (data, textStatus, jqXHR) {
							// Notify all Cart Summary modules to rebind
                            $(".rvdsf-cartsummary-container").each(function () {
                                this.databind()
							})

                            salesRegisterContainer.databind()
                        })
                    }

                    this.viewModel.resetProducts = function () {
                        $('#rvdsfProductSearchQueryInput').val('')
                        that.viewModel.Products.removeAll()
                    }

                    this.viewModel.saveBilling = function () {
                        var validationResult = $('#rvdsfBillingSalesRegisterContainer input, #rvdsfBillingSalesRegisterContainer select, #rvdsfBillingSalesRegisterContainer textarea').valid()

                        if (validationResult) {
                            var promise = that.viewModel.updateSalesOrderSet("BillingInformation")
                            promise.done(function () {
                                that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                $('#rvdsfBillingSalesRegisterModal').modal('hide')
                            })
                        }
                    }

                    this.viewModel.saveCustomer = function () {

                        that.viewModel.CustomerError(null)

                        // Existing user specified
                        if (that.viewModel.SalesOrderSet.Customer.UserID()) {
                                
                            var promise = that.viewModel.updateSalesOrderSet("UserInformation")
                            promise.done(function () {
                                that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                $('#rvdsfCustomerSalesRegisterModal').modal('hide')
                            })
                        }

                        // Create new user
                        else if (!that.viewModel.SalesOrderSet.Customer.UserID() &&
                                (that.viewModel.SalesOrderSet.Customer.FirstName() ||
                                 that.viewModel.SalesOrderSet.Customer.LastName() ||
                                 that.viewModel.SalesOrderSet.Customer.Email() ||
                                 that.viewModel.SalesOrderSet.Customer.Phone())
                            ) {

                            var validationResult = $('#rvdsfCustomerSalesRegisterContainer input, #rvdsfCustomerSalesRegisterContainer select, #rvdsfCustomerSalesRegisterContainer textarea').valid()

                            if (validationResult) {

                                var userData = {
                                    FirstName: that.viewModel.SalesOrderSet.Customer.FirstName(),
                                    LastName: that.viewModel.SalesOrderSet.Customer.LastName(),
                                    Email: that.viewModel.SalesOrderSet.Customer.Email(),
                                    Phone: that.viewModel.SalesOrderSet.Customer.Phone()
                                }

                                $.ajax({
                			        type: "POST",
                			        beforeSend: servicesFramework.setModuleHeaders,
                			        url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/User",
                			        data: userData
                		        })
                                .done(function (data, textStatus, jqXHR) {
                                    that.viewModel.SalesOrderSet.Customer.UserID(data.UserID)
                                    that.viewModel.SalesOrderSet.Customer.Username(data.Username)
                                    that.viewModel.SalesOrderSet.Customer.FirstName(data.FirstName)
                                    that.viewModel.SalesOrderSet.Customer.LastName(data.LastName)
                                    that.viewModel.SalesOrderSet.Customer.Email(data.Email)
                                    that.viewModel.SalesOrderSet.Customer.Phone(data.Profile.Telephone)

                                    var promise = that.viewModel.updateSalesOrderSet("UserInformation")
                                    promise.done(function () {

                                        that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                        $('#rvdsfCustomerSalesRegisterModal').modal('hide')
                                    })
                                })
                                .fail(function (data, textStatus, errorThrown) {
								    that.viewModel.CustomerError(data.responseJSON.Message)
						        })
                            }
                        }

                        // Anonymous user
                        else {
                            var promise = that.viewModel.updateSalesOrderSet("UserInformation")
                            promise.done(function () {
                                that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                $('#rvdsfCustomerSalesRegisterModal').modal('hide')
                            })
                        }
                    }

                    this.viewModel.saveNotes = function () {
                        that.viewModel.SalesOrderSet.AdminNotes($('#rvdsfAdminNotesSalesRegisterContainer').summernote('code'))
                        that.viewModel.updateSalesOrderSet('Notes');

                        $('#rvdsfNotesSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.saveSalesOrderDetail = function () {
                        that.viewModel.SalesOrderDetailError(null)

                        var promise = that.viewModel.updateSalesOrderDetail(that.viewModel.SalesOrderDetail().SalesOrderDetailID(), that.viewModel.SalesOrderDetailQuantity())
                        promise.done(function () {
                            that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                            $('#rvdsfSalesOrderDetailSalesRegisterModal').modal('hide')
                        })
                        .fail(function (data, textStatus, errorThrown) {
							if ($.trim(data.responseText))
								that.viewModel.SalesOrderDetailError(data.responseJSON.Message)
						})
                    }

                    this.viewModel.saveSettings = function () {
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterPrinterIPAddress + "|" + Dnn.Portal.PortalId)', that.viewModel.PrinterIPAddress());
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterPrinterPort + "|" + Dnn.Portal.PortalId)', that.viewModel.PrinterPort());
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterPrinterCopies + "|" + Dnn.Portal.PortalId)', that.viewModel.PrinterCopies());
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterDefaultCustomer + "|" + Dnn.Portal.PortalId)', that.viewModel.DefaultCustomer.UserID());

                        $('#rvdsfSettingsSalesRegisterModal').modal('hide')
                    }

                    this.viewModel.saveShipping = function () {
                        var validationResult = $('#rvdsfShippingSalesRegisterContainer input, #rvdsfShippingSalesRegisterContainer select, #rvdsfShippingSalesRegisterContainer textarea').valid()

                        if (validationResult) {
                            var promise = that.viewModel.updateSalesOrderSet("ShippingInformation")
                            promise.done(function () {
                                that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())

                                $('#rvdsfShippingSalesRegisterModal').modal('hide')
                            })
                        }
                    }

                    this.viewModel.searchProducts = function () {

                        that.viewModel.Products.removeAll()

                        var productSearchData = {
                            CategoryID: that.viewModel.SelectedCategory(),
                            Query: $('#rvdsfProductSearchQueryInput').val(),
                        }

                        $.ajax({
                			type: "POST",
                			beforeSend: servicesFramework.setModuleHeaders,
                			url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "Product/Search",
                			data: productSearchData
                		})
                        .done(function (data, textStatus, jqXHR) {
                            data.map(p => {
                                that.viewModel.Products.push(p)
                            })
                        })
                    }

                    this.viewModel.setSalesRegisterOperatorUserID = function (userID) {
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterOperatorUserID + "|" + Dnn.Portal.PortalId)', userID)
                    }

                    this.viewModel.setSalesRegisterSalesDefaultCustomer = function (userID) {
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterDefaultCustomer + "|" + Dnn.Portal.PortalId)', JSON.stringify(userID))
                    }

                    this.viewModel.setSalesRegisterSalesPayments = function (payments) {
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterSalesPayments + "|" + Dnn.Portal.PortalId)', JSON.stringify(payments))
                    }

                    this.viewModel.shippingAddressChanged = function () {
                        // TODO:
						//if (this.SameAsBilling()) {
						//	this.copyBillingToShippingAddress()
						//	this.getAvailableShippingMethods()
						//}
                    }

                    this.viewModel.shippingCountryChanged = function () {

						var get = $.ajax({
							context: this,
							type: "GET",
							beforeSend: servicesFramework.setModuleHeaders,
							url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "Globalization/Subdivisions?Active=true&CountryCode=" + this.SalesOrderSet.ShippingCountryCode(),
						})

						get.done(function (data, textStatus, jqXHR) {

							var country = null
							this.ShippingCountries().map(function (c) {
								if (c.IsoAlpha2Code == this.SalesOrderSet.ShippingCountryCode())
									country = c
							}, this)

							if (country) {
								this.ShippingDistrictRequired(country.HasDistrictSystem)
								this.ShippingPostalCodeRequired(country.HasPostalCodeSystem)
							}

							// Change underlying array items and fire valueHasMutated to prevent
							// calling getAvailableShippingMethods repeatedly as array is being changed
							var shippingSubdivisions = this.ShippingSubdivisions()
							shippingSubdivisions.length = 0

							shippingSubdivisions.push({ Name: '', IsoCode: '' })
							if (country.IsSubdivisionRequired) {
								$.each(data, function () {
									shippingSubdivisions.push({ Name: this.Name, IsoCode: this.IsoCode })
								})
							}
							this.ShippingSubdivisions.valueHasMutated()

							if (!this.SalesOrderSet.ShippingSubdivisionCode() || !this.SalesOrderSet.ShippingSubdivisionCode().startsWith(this.SalesOrderSet.ShippingCountryCode())) {
								if (this.ShippingSubdivisions().length > 0)
									this.SalesOrderSet.ShippingSubdivisionCode(this.ShippingSubdivisions()[0].IsoCode)
								else
									this.SalesOrderSet.ShippingSubdivisionCode(null)
							}
						})

						return get
					}

                    this.viewModel.showCoupons = function () {
                        $('#rvdsfCouponsSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
                    }

                    this.viewModel.showCustomer = function () {
                        $('#rvdsfCustomerSalesRegisterModal').modal({ backdrop: 'static' }).modal('show')

                        // Reset validation styles
                        $('#rvdsfCustomerSalesRegisterContainer div.form-group').removeClass('has-error');
                        $('#rvdsfCustomerSalesRegisterContainer input').removeClass('is-invalid');
                        $('#rvdsfCustomerSalesRegisterContainer .help-block').hide()
					}

                    this.viewModel.showBilling = function () {
                        $('#rvdsfBillingSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
					}

                    this.viewModel.showNotes = function () {
                        that.databind(that.viewModel.SalesOrderSet.SalesOrder().SalesOrderNumber())
                        $('#rvdsfNotesSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
                    }

                    this.viewModel.showSalesOrderDetail = function (salesOrderDetail) {
                        that.viewModel.SalesOrderDetail(salesOrderDetail)
                        that.viewModel.SalesOrderDetailQuantity(salesOrderDetail.Quantity())
                        
                        $('#rvdsfSalesOrderDetailSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
                    }

                    this.viewModel.showSalesPayments = function () {
                        that.viewModel.VoucherCode(null)
                        that.viewModel.PaymentAmount(that.viewModel.SalesOrderSet.BalanceDue().toFixed(2))

                        $('#rvdsfSalesPaymentsSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
					}

                    this.viewModel.showSalesOrders = function () {
                        $('#rvdsfSalesOrdersSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
                    }

                    this.viewModel.showSession = function () {
                        $('#rvdsfSessionSalesRegisterModal').modal({backdrop: 'static'}).modal('show')

                        // Need to clean node if we are rebinding multiple times
                        var sessionSalesRegisterContainer = document.getElementById("rvdsfSessionSalesRegisterContainer")
                        ko.cleanNode(sessionSalesRegisterContainer)
                        ko.applyBindings(that.viewModel, sessionSalesRegisterContainer)
                    }

                    this.viewModel.showSettings = function () {
                        that.viewModel.SalesRegisterKey(that.viewModel.getSalesRegisterKey())
                        that.viewModel.PrinterIPAddress(that.viewModel.getSalesRegisterPrinterIPAddress())
                        that.viewModel.PrinterPort(that.viewModel.getSalesRegisterPrinterPort())
                        that.viewModel.PrinterCopies(that.viewModel.getSalesRegisterPrinterCopies())

                        $('#rvdsfSettingsSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
                    }

                    this.viewModel.showShipping = function () {
                        $('#rvdsfShippingSalesRegisterModal').modal({backdrop: 'static'}).modal('show')
                    }

                    this.viewModel.startSalesRegister = function () {
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterSalesPayments + "|" + Dnn.Portal.PortalId)', JSON.stringify([]))
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterStartCash + "|" + Dnn.Portal.PortalId)', $('#rvdsfStartCashSalesRegisterInput').val())
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterStartDate + "|" + Dnn.Portal.PortalId)', new moment().format("YYYY-MM-DD HH:mm:ss"))
                        localStorage.setItem('@(Global.LocalStorageKeys.SalesRegisterOperatorUserID + "|" + Dnn.Portal.PortalId)', @Dnn.User.UserID)

                        location.reload()
                    }

                    this.viewModel.stopSalesRegister = function () {

                        var salesRegisterData = {
                            SalesRegisterKey: dnn.dom.getCookie('@(Global.CookieKeys.SalesRegisterKey + "|" + Dnn.Portal.PortalId)')
                        }

                        $.ajax({
                            type: "DELETE",
                            beforeSend: servicesFramework.setModuleHeaders,
                            url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesRegister",
                            data: salesRegisterData
                        })

                        localStorage.removeItem('@(Global.LocalStorageKeys.SalesRegisterSalesPayments + "|" + Dnn.Portal.PortalId)')
                        localStorage.removeItem('@(Global.LocalStorageKeys.SalesRegisterStartCash + "|" + Dnn.Portal.PortalId)')
                        localStorage.removeItem('@(Global.LocalStorageKeys.SalesRegisterStartDate + "|" + Dnn.Portal.PortalId)')
                        localStorage.removeItem('@(Global.LocalStorageKeys.SalesRegisterOperatorUserID + "|" + Dnn.Portal.PortalId)')
                            
                        location.reload()
                    }

                    this.viewModel.toggleFullscreen = function () {
						if ($('#rvdsfSalesRegisterContainer').hasClass("show") || $('#rvdsfSalesRegisterContainer').hasClass("in"))
							$('#rvdsfSalesRegisterContainer').modal('hide')
						else
							$('#rvdsfSalesRegisterContainer').modal({backdrop: false}).modal('show')
					}

                    // TODO:
                    this.viewModel.updateCart = function () {

                        var salesOrderDetailDataList = []

						that.viewModel.SalesOrderSet.MainSalesOrderDetails().map(function (sod) {
							if (sod.PreviousQuantity() != sod.Quantity()) {
								var salesOrderDetailData = { SalesOrderDetailID: sod.SalesOrderDetailID(), Quantity: sod.Quantity() }
								salesOrderDetailDataList.push(salesOrderDetailData)
							}
                        })

                        $.ajax({
                            type: "PUT",
                            beforeSend: servicesFramework.setModuleHeaders,
                            url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "Cart/SalesOrderDetails",
                            data: JSON.stringify(salesOrderDetailDataList),
                            contentType: 'application/json'
                        })
                        .done(function (data, textStatus, jqXHR) {
							// Notify all Cart Summary modules to rebind
                            $(".rvdsf-cartsummary-container").each(function () {
                                this.databind()
							})

                            salesRegisterContainer.databind()
                        })
                    }

                    this.viewModel.updateSalesOrderDetail = function (salesOrderDetailID, quantity) {
                		var salesOrderDetailData = {
                			SalesOrderDetailID: salesOrderDetailID,
                            Quantity: quantity,
                            SalesOrderID: that.viewModel.SalesOrderSet.SalesOrder().SalesOrderID()
                		}

                		var servicesFramework = $.ServicesFramework(@Html.Raw(Request.QueryString.ToString()));

                		return $.ajax({
                			type: "PUT",
                			beforeSend: servicesFramework.setModuleHeaders,
                			url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesOrderDetail",
                			data: salesOrderDetailData
                		})
                    }

                    this.viewModel.updateSalesOrderSet = function (operation) {

                        // TODO:
						var salesOrderSetData = {
                            Operation: operation,
                            AdminNotes: this.SalesOrderSet.AdminNotes(),
							//PaymentReturnAction: "@this.Request.QueryString[Global.QueryStringKeys.PaymentReturnAction] == "success" ? "false" : "true"",
							//TransactionToken: "@this.Request.QueryString[Global.QueryStringKeys.TransactionToken]",
							BillingCity: this.SalesOrderSet.BillingCity(),
							BillingCompany: this.SalesOrderSet.BillingCompany(),
							BillingCountryCode: this.SalesOrderSet.BillingCountryCode(),
							BillingEmail: this.SalesOrderSet.BillingEmail(),
							BillingFirstName: this.SalesOrderSet.BillingFirstName(),
							BillingLastName: this.SalesOrderSet.BillingLastName(),
							BillingPostalCode: this.SalesOrderSet.BillingPostalCode(),
							BillingPhone: this.SalesOrderSet.BillingPhone(),
							BillingStreet: this.SalesOrderSet.BillingStreet(),
							BillingUnit: this.SalesOrderSet.BillingUnit(),
							BillingDistrict: this.SalesOrderSet.BillingDistrict(),
							BillingSubdivisionCode: this.SalesOrderSet.BillingSubdivisionCode(),
							BusinessTaxNumber: this.SalesOrderSet.BusinessTaxNumber(),
							//SaveBillingUserAddress: true,
                            //SaveShippingUserAddress: true,
                            SalesOrderGUID: this.SalesOrderSet.SalesOrder().SalesOrderGUID(),
							ShippingCity: this.SalesOrderSet.ShippingCity(),
							ShippingCompany: this.SalesOrderSet.ShippingCompany(),
							ShippingCountryCode: this.SalesOrderSet.ShippingCountryCode(),
							ShippingEmail: this.SalesOrderSet.ShippingEmail(),
							ShippingFirstName: this.SalesOrderSet.ShippingFirstName(),
							ShippingLastName: this.SalesOrderSet.ShippingLastName(),
							ShippingPostalCode: this.SalesOrderSet.ShippingPostalCode(),
							ShippingPhone: this.SalesOrderSet.ShippingPhone(),
							ShippingStreet: this.SalesOrderSet.ShippingStreet(),
							ShippingUnit: this.SalesOrderSet.ShippingUnit(),
							ShippingDistrict: this.SalesOrderSet.ShippingDistrict(),
							ShippingSubdivisionCode: this.SalesOrderSet.ShippingSubdivisionCode(),
							//PaymentTerm: this.PrimaryPaymentTerm(),
							//PurchaseOrderNumber: this.SalesOrderSet.PurchaseOrderNumber(),
							//UpdateUserProfile: this.UpdateUserProfile(),
							//SaveUserPayment: this.SaveUserPayment(),
							//SpamToken: this.SpamToken(),
                            UserID: this.SalesOrderSet.Customer.UserID()
                        }

      //                  if (operation.indexOf("CustomField") >= 0) {
						//	salesOrderSetData.DynamicFormResult = $dynamicFormResultFields.children().length ? $('<div />').append($dynamicFormResultFields).html() : null

						//	// BUG: Replace lowercase XML names that get generated by IE11 only.
						//	if (salesOrderSetData.DynamicFormResult)
						//		salesOrderSetData.DynamicFormResult = salesOrderSetData.DynamicFormResult.replace(/postedfile>/g, 'postedFile>').replace(/contentlength>/g, 'contentLength>').replace(/contenttype>/g, 'contentType>').replace(/filename>/g, 'fileName>')
						//}

						var put = $.ajax({
							context: this,
							type: "PUT",
							beforeSend: servicesFramework.setModuleHeaders,
							url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "SalesRegister/SalesOrderSet?@Html.Raw(Request.QueryString.ToString())",
							data: salesOrderSetData
						})

						return put
					}

                    // Helper function to format currency
                    this.viewModel.formatCurrency = function (number) {
                        return new Intl.NumberFormat(this.Currency.CultureCode(), { style: 'currency', currency: this.Currency.CurrencyCode() }).format((typeof number === "function" ? number() : number) * this.Currency.ExchangeRate());
                    }

                    ko.applyBindings(this.viewModel, salesRegisterContainer)

                    // Initialize
                    this.viewModel.listProducts()
                    this.viewModel.initializePrinter()
                    setInterval(function () { that.viewModel.initializePrinter(); }, 30000) // Monitor printer periodically

                    // Initialize countries
					$.ajax({
						context: this,
						type: "GET",
						beforeSend: servicesFramework.setModuleHeaders,
						url: servicesFramework.getServiceRoot("@Dnn.Module.DesktopModule.FolderName") + "Globalization/Countries?Active=true",
					})
					.done(function (data, textStatus, jqXHR) {

						this.viewModel.BillingCountries.removeAll()
						this.viewModel.ShippingCountries.removeAll()

						var that = this
						that.viewModel.BillingCountries.push({ Name: '', IsoAlpha2Code: '', HasPostalCodeSystem: false, IsSubdivisionRequired: false })
						that.viewModel.ShippingCountries.push({ Name: '', IsoAlpha2Code: '', HasPostalCodeSystem: false, IsSubdivisionRequired: false })

						$.each(data, function () {
							that.viewModel.BillingCountries.push(this)
							that.viewModel.ShippingCountries.push(this)
						});

						this.viewModel.billingCountryChanged()
						.done(function (data, textStatus, jqXHR) {
							that.viewModel.shippingCountryChanged()
                                .done(function (data, textStatus, jqXHR) {
                                // TODO:
								//ko.applyBindings(that.viewModel, salesRegisterContainer)

								//that.viewModel.getAvailableShippingMethods()

								//if (@(this.Request.QueryString[Global.QueryStringKeys.PaymentReturnAction] == "success" ? "false" : "true"))
								//	that.viewModel.initializePayment()
							})
						})
					})
                }
            })
        }

        salesRegisterContainer.databind()

        // Set default focus to input search
        $('#rvdsfProductSearchQueryInput').focus()

        // Resize left column dynamically for desktop view
		if ($(window).width() >= 768) {
            setInterval(function () {
                if ($("#rvdsfProductSearchSalesRegisterContainer").length > 0) {
                    var productSearchHeight = window.innerHeight - Math.max(0, $("#rvdsfProductSearchSalesRegisterContainer").offset().top - $(document).scrollTop()) - 110
                    $("#rvdsfProductSearchSalesRegisterContainer").css("height", productSearchHeight + "px")
                }

                if ($("#rvdsfSalesOrderDetailsSalesRegisterContainer").length > 0) {
                    var salesOrderDetailsHeight = window.innerHeight - Math.max(0, $("#rvdsfSalesOrderDetailsSalesRegisterContainer").offset().top - $(document).scrollTop()) - 110
                    $("#rvdsfSalesOrderDetailsSalesRegisterContainer").css("height", salesOrderDetailsHeight + "px")
                }
			}, 1000)
		}
    })
</script>
