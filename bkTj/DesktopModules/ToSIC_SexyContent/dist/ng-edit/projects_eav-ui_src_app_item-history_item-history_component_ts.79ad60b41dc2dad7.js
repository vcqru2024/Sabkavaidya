"use strict";(self.webpackChunkeav_ui=self.webpackChunkeav_ui||[]).push([["projects_eav-ui_src_app_item-history_item-history_component_ts"],{4620:(tt,C,l)=>{l.r(C),l.d(C,{ItemHistoryComponent:()=>q});var h=l(4844),y=l(5876),v=l(604);function b(n,i,e){const o=JSON.parse(n.Json).Entity.Attributes,a="live"===e?function G(n){let i=n[0];for(const e of n)e.VersionNumber<=i.VersionNumber||(i=e);return i}(i):i.find(r=>r.VersionNumber===n.VersionNumber-1),s=a?JSON.parse(a.Json).Entity.Attributes:null,c=[];return null!=o&&Object.entries(o).forEach(([r,d])=>{Object.keys(d).forEach(_=>{null==c.find(p=>p.name===_&&p.dataType===r)&&c.push({name:_,dataType:r})})}),null!=s&&Object.entries(s).forEach(([r,d])=>{Object.keys(d).forEach(_=>{null==c.find(p=>p.name===_&&p.dataType===r)&&c.push({name:_,dataType:r})})}),c.map(r=>{const d=o?.[r.dataType]?.[r.name],_=s?.[r.dataType]?.[r.name];return{name:r.name,dataType:r.dataType,change:g(d,_,!0),values:Y(d,_)}})}function Y(n,i){const e=[];return null!=n&&Object.keys(n).forEach(a=>{e.includes(a)||e.push(a)}),null!=i&&Object.keys(i).forEach(a=>{e.includes(a)||e.push(a)}),e.map(a=>{const s=n?.[a],c=i?.[a];return{langKey:a,value:s,oldValue:c,change:g(s,c)}})}function g(n,i,e=!1){let o;return e&&("object"==typeof n&&(n=f(n)),"object"==typeof i&&(i=f(i))),o=null!=n&&null!=i?JSON.stringify(n)!==JSON.stringify(i)?"changed":"none":null!=n?"new":"deleted",o}function f(n){return"object"!=typeof n?n:Object.keys(n).sort().reduce((i,e)=>({...i,[e]:n[e]}),{})}var T=l(8768),t=l(4896),S=l(600),R=l(5204),w=l(4648),E=l(8200),I=l(4672),H=l(2328),u=l(6016),F=l(8276),k=l(244),P=l(7872),M=l(6176),x=l(5056);function A(n,i){if(1&n){const e=t.KQA();t.I0R(0,"div",9)(1,"mat-form-field",10)(2,"mat-select",11),t.qCj("selectionChange",function(a){t.usT(e);const s=t.GaO(2);return t.CGJ(s.compareChange(a.value))}),t.I0R(3,"mat-option",12),t.OEk(4,"Compare with: Previous"),t.C$Y(),t.I0R(5,"mat-option",13),t.OEk(6,"Compare with: Live"),t.C$Y()()()()}if(2&n){const e=t.GaO();t.yG2(2),t.E7m("value",e.compareWith)}}function N(n,i){1&n&&(t.I0R(0,"div"),t.OEk(1,"Loading..."),t.C$Y())}function z(n,i){1&n&&(t.I0R(0,"div"),t.OEk(1,"No previous versions of this item found"),t.C$Y())}function j(n,i){if(1&n&&t.OEk(0),2&n){const e=t.GaO().$implicit;t.oRS(" ",null==e.values[0]?null:e.values[0].value," ")}}function V(n,i){if(1&n&&(t.I0R(0,"div"),t.OEk(1),t.C$Y()),2&n){const e=t.GaO().$implicit;t.uQ9("eav-history-",e.change,""),t.yG2(1),t.oRS(" ","deleted"===e.change?e.oldValue:e.value," ")}}function J(n,i){if(1&n&&(t.I0R(0,"div",27),t.OEk(1),t.C$Y(),t.I0R(2,"div",28),t.OEk(3),t.C$Y()),2&n){const e=t.GaO().$implicit;t.yG2(1),t.cNF(e.value),t.yG2(2),t.cNF(e.oldValue)}}function Q(n,i){if(1&n&&(t.I0R(0,"div",24)(1,"div"),t.OEk(2),t.C$Y(),t.I0R(3,"div",25),t.yuY(4,V,2,4,"div",26)(5,J,4,2),t.C$Y()()),2&n){const e=i.$implicit;t.yG2(1),t.uQ9("eav-detail-row__label eav-history-",e.change,""),t.yG2(1),t.oRS("",e.langKey,":"),t.yG2(2),t.C0Y(4,"changed"!==e.change?4:-1),t.yG2(1),t.C0Y(5,"changed"===e.change?5:-1)}}function L(n,i){if(1&n&&(t.I0R(0,"div",23),t.c53(1,Q,6,6,"div",29,t.oxv),t.C$Y()),2&n){const e=t.GaO().$implicit;t.yG2(1),t.oho(e.values)}}function B(n,i){if(1&n){const e=t.KQA();t.I0R(0,"div",19)(1,"div",20),t.qCj("click",function(){const s=t.usT(e).$implicit,c=t.GaO(2).$implicit,m=t.GaO(3);return t.CGJ(m.attributeExpandedToggle(c.versionNumber,s.name))}),t.I0R(2,"div"),t.OEk(3),t.C$Y(),t.I0R(4,"div"),t.yuY(5,j,1,1),t.C$Y(),t.I0R(6,"div",21)(7,"i"),t.OEk(8),t.C$Y()()(),t.yuY(9,L,3,0,"div",22),t.C$Y()}if(2&n){const e=i.$implicit,o=t.GaO(2).$implicit,a=t.GaO(3);t.yG2(2),t.uQ9("eav-row-main__label eav-history-",e.change,""),t.yG2(1),t.oRS(" ",e.name," "),t.yG2(1),t.uQ9("eav-row-main__value eav-history-",e.change,""),t.yG2(1),t.C0Y(5,a.expandedAttributes[o.versionNumber+e.name]?-1:5),t.yG2(3),t.oRS("[",e.dataType,"]"),t.yG2(1),t.C0Y(9,a.expandedAttributes[o.versionNumber+e.name]?9:-1)}}function K(n,i){if(1&n){const e=t.KQA();t.I0R(0,"button",30),t.qCj("click",function(){t.usT(e);const a=t.GaO(2).$implicit,s=t.GaO(3);return t.CGJ(s.restore(a.changeSetId))}),t.OEk(1," Restore "),t.C$Y()}}function D(n,i){if(1&n&&(t.c53(0,B,10,10,"div",31,t.oxv),t.I0R(2,"div",17),t.yuY(3,K,2,0,"button",18),t.C$Y()),2&n){const e=t.GaO().$implicit;t.oho(e.attributes),t.yG2(3),t.C0Y(3,e.isLastVersion?-1:3)}}function W(n,i){if(1&n){const e=t.KQA();t.I0R(0,"mat-expansion-panel",15),t.qCj("expandedChange",function(a){const c=t.usT(e).$implicit,m=t.GaO(3);return t.CGJ(m.panelExpandedChange(a,c.versionNumber))}),t.I0R(1,"mat-expansion-panel-header")(2,"mat-panel-title"),t.OEk(3),t.C$Y(),t.I0R(4,"mat-panel-description"),t.OEk(5),t.wVc(6,"date"),t.C$Y()(),t.yuY(7,D,4,1,"div",16),t.C$Y()}if(2&n){const e=i.$implicit,o=t.GaO(3);t.E7m("expanded",o.expandedPanels[e.versionNumber]),t.yG2(3),t.oRS("Version ",e.versionNumber,""),t.yG2(2),t.cNF(t.g7$(6,4,e.timeStamp,"yyyy-MM-dd hh:mm")),t.yG2(2),t.C0Y(7,o.expandedPanels[e.versionNumber]?7:-1)}}function U(n,i){if(1&n&&(t.I0R(0,"mat-accordion",14),t.c53(1,W,8,7,"mat-expansion-panel",32,t.oxv),t.C$Y()),2&n){const e=t.GaO();t.yG2(1),t.oho(e.historyItems)}}function X(n,i){if(1&n){const e=t.KQA();t.I0R(0,"mat-paginator",33),t.qCj("page",function(a){t.usT(e);const s=t.GaO(2);return t.CGJ(s.pageChange(a))}),t.C$Y()}if(2&n){const e=t.GaO(),o=t.GaO();t.E7m("length",e.length)("pageSize",e.pageSize)("pageSizeOptions",o.pageSizeOptions)}}function Z(n,i){if(1&n){const e=t.KQA();t.I0R(0,"div",1)(1,"div",2)(2,"div",3),t.OEk(3,"Item History"),t.C$Y(),t.I0R(4,"button",4),t.qCj("click",function(){t.usT(e);const a=t.GaO();return t.CGJ(a.closeDialog())}),t.I0R(5,"mat-icon"),t.OEk(6,"close"),t.C$Y()()(),t.I0R(7,"div",5)(8,"p"),t.OEk(9,"Check version history for this item and restore the version you need."),t.C$Y(),t.yuY(10,A,7,1,"div",6),t.I0R(11,"div"),t.yuY(12,N,2,0,"div")(13,z,2,0,"div")(14,U,3,0,"mat-accordion",7),t.C$Y(),t.yuY(15,X,1,3,"mat-paginator",8),t.C$Y()()}2&n&&(t.yG2(10),t.C0Y(10,(null==i.historyItems?null:i.historyItems.length)>0?10:-1),t.yG2(2),t.C0Y(12,null===i.historyItems?12:-1),t.yG2(1),t.C0Y(13,0===(null==i.historyItems?null:i.historyItems.length)?13:-1),t.yG2(1),t.C0Y(14,(null==i.historyItems?null:i.historyItems.length)>0?14:-1),t.yG2(1),t.C0Y(15,(null==i.historyItems?null:i.historyItems.length)>0?15:-1))}let q=(()=>{class n{constructor(e,o,a,s){this.dialogRef=e,this.route=o,this.versionsService=a,this.snackBar=s,this.hostClass="dialog-component",this.pageSizeOptions=[10,20,50],this.expandedPanels={},this.expandedAttributes={},this.itemId=parseInt(this.route.snapshot.paramMap.get("itemId"),10),this.versions$=new h.g(null),this.page$=new h.g(1),this.pageSize$=new h.g(this.pageSizeOptions[0]),this.compareWith$=new h.g("live"),this.historyItems$=(0,y.E)([this.versions$,this.page$,this.pageSize$,this.compareWith$]).pipe((0,v.k)(([c,m,r,d])=>function O(n,i,e,o){return null==n||null==i||null==e||null==o?null:function $(n,i,e){return n.map(o=>({changeSetId:o.ChangeSetId,attributes:b(o,i,e),historyId:o.HistoryId,timeStamp:o.TimeStamp,user:o.User,versionNumber:o.VersionNumber,isLastVersion:!i.some(s=>s.VersionNumber===o.VersionNumber+1)}))}(n.slice((i-1)*e,i*e),n,o)}(c,m,r,d))),this.viewModel$=(0,y.E)([this.versions$,this.historyItems$,this.pageSize$,this.compareWith$]).pipe((0,v.k)(([c,m,r,d])=>({length:c?.length,historyItems:m,pageSize:r,compareWith:d})))}ngOnInit(){this.versionsService.fetchVersions(this.itemId).subscribe(e=>{this.versions$.next(e)})}ngOnDestroy(){this.versions$.complete(),this.page$.complete(),this.pageSize$.complete(),this.compareWith$.complete()}closeDialog(){this.dialogRef.close()}compareChange(e){this.compareWith$.next(e)}panelExpandedChange(e,o){this.expandedPanels[o]=e}attributeExpandedToggle(e,o){this.expandedAttributes[e+o]=!this.expandedAttributes[e+o]}pageChange(e){const o=e.pageIndex+1;o!==this.page$.value&&(this.expandedPanels={},this.expandedAttributes={},this.page$.next(o));const a=e.pageSize;a!==this.pageSize$.value&&this.pageSize$.next(a)}restore(e){this.snackBar.open("Restoring previous version..."),this.versionsService.restore(this.itemId,e).subscribe(o=>{this.snackBar.open("Previous version restored. Will reload edit dialog",null,{duration:3e3}),this.dialogRef.close({refreshEdit:!0})})}static#t=this.\u0275fac=function(o){return new(o||n)(t.GI1(S.yI),t.GI1(R.gV),t.GI1(T.U),t.GI1(w.yS))};static#e=this.\u0275cmp=t.In1({type:n,selectors:[["app-item-history"]],hostVars:1,hostBindings:function(o,a){2&o&&t.SoX("className",a.hostClass)},decls:2,vars:3,consts:[["class","eav-dialog eav-no-scrollbar"],[1,"eav-dialog","eav-no-scrollbar"],[1,"eav-dialog-header"],[1,"eav-dialog-header__title"],["mat-icon-button","","tippy","Close dialog",3,"click"],[1,"eav-dialog-content"],["class","eav-compare-box"],["multi","","class","eav-history-tables"],["color","accent","showFirstLastButtons","true",3,"length","pageSize","pageSizeOptions"],[1,"eav-compare-box"],["color","accent",1,"eav-form-field","eav-compare-box__dropdown"],["name","Scope",3,"value","selectionChange"],["value","previous"],["value","live"],["multi","",1,"eav-history-tables"],[3,"expanded","expandedChange"],["class","eav-row-actions"],[1,"eav-row-actions"],["mat-raised-button","","color","accent"],[1,"eav-table-row"],[1,"eav-table-row__main","eav-row-main",3,"click"],[1,"eav-row-main__type"],["class","eav-table-row__details"],[1,"eav-table-row__details"],[1,"eav-detail-row"],[1,"eav-detail-row__value"],[3,"class"],[1,"eav-history-new"],[1,"eav-history-deleted","eav-history-deleted__value"],["class","eav-detail-row"],["mat-raised-button","","color","accent",3,"click"],["class","eav-table-row"],[3,"expanded"],["color","accent","showFirstLastButtons","true",3,"length","pageSize","pageSizeOptions","page"]],template:function(o,a){if(1&o&&(t.yuY(0,Z,16,5,"div",0),t.wVc(1,"async")),2&o){let s;t.C0Y(0,(s=t.kDX(1,1,a.viewModel$))?0:-1,s)}},dependencies:[E.Y,I.Gw,I.um,H.qL,u._2,u._s,u.nm,u.CM,u._A,F.Qb,k.Up,P.kX,M.I5,x.a,x.y],styles:[".eav-compare-box[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;align-items:flex-end;height:40px}.eav-compare-box__dropdown[_ngcontent-%COMP%]{width:192px;margin-top:-14px;font-size:14px;height:auto}.eav-accordion[_ngcontent-%COMP%]{display:block;padding:4px 0}.eav-expansion-panel-header[_ngcontent-%COMP%], .eav-table-row[_ngcontent-%COMP%]{font-size:14px}.eav-table-row__main[_ngcontent-%COMP%]{display:flex}.eav-table-row__details[_ngcontent-%COMP%]{display:block}.eav-row-main[_ngcontent-%COMP%]{cursor:pointer;padding:4px 0}.eav-row-main__label[_ngcontent-%COMP%]{width:160px;flex:0 0 auto}.eav-row-main__value[_ngcontent-%COMP%]{flex:1 1 auto}.eav-row-main__type[_ngcontent-%COMP%]{flex:0 0 auto;font-size:12px}.eav-row-main__type[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]:not(:last-of-type){margin-right:2px}.eav-detail-row[_ngcontent-%COMP%]{display:flex;padding-bottom:4px;cursor:default}.eav-detail-row__label[_ngcontent-%COMP%]{width:160px;flex:0 0 auto}.eav-detail-row__value[_ngcontent-%COMP%]{flex:1 1 auto}.eav-row-actions[_ngcontent-%COMP%]{margin-top:16px;display:flex;justify-content:flex-end}"]})}return n})()}}]);
//# sourceMappingURL=https://sources.2sxc.org/17.04.00/dist/ng-edit/projects_eav-ui_src_app_item-history_item-history_component_ts.79ad60b41dc2dad7.js.map